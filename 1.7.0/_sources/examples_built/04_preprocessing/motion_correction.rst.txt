
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples_built/04_preprocessing/motion_correction.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_examples_built_04_preprocessing_motion_correction.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_built_04_preprocessing_motion_correction.py:


=================================================
Between-volumes Motion Correction on DWI datasets
=================================================

Overview
--------
During a dMRI acquisition, the subject motion inevitable. This motion implies
a misalignment between N volumes on a dMRI dataset. A common way to solve this
issue is to perform a registration on each acquired volume to a
reference b = 0. [JenkinsonSmith01]_

This preprocessing is an highly recommended step that should be executed before
any dMRI dataset analysis.


Let's import some essential functions.

.. GENERATED FROM PYTHON SOURCE LINES 21-28

.. code-block:: default


    from dipy.align import motion_correction
    from dipy.core.gradients import gradient_table
    from dipy.data import get_fnames
    from dipy.io.image import load_nifti, save_nifti
    from dipy.io.gradients import read_bvals_bvecs








.. GENERATED FROM PYTHON SOURCE LINES 29-31

We choose one of the data from the datasets in dipy_. However, you can
replace the following line with the path of your image.

.. GENERATED FROM PYTHON SOURCE LINES 31-35

.. code-block:: default



    dwi_fname, dwi_bval_fname, dwi_bvec_fname = get_fnames('sherbrooke_3shell')








.. GENERATED FROM PYTHON SOURCE LINES 36-39

We load the image and the affine of the image. The affine is the transformation
matrix which maps image coordinates to world (mm) coordinates. We also load the
b-values and b-vectors.

.. GENERATED FROM PYTHON SOURCE LINES 39-44

.. code-block:: default



    data, affine = load_nifti(dwi_fname)
    bvals, bvecs = read_bvals_bvecs(dwi_bval_fname, dwi_bvec_fname)








.. GENERATED FROM PYTHON SOURCE LINES 45-48

This data has 193 volumes. For this demo purpose, we decide to reduce the
number of volumes to 5. However, we do not recommended to perform a motion
correction with less than 10 volumes.

.. GENERATED FROM PYTHON SOURCE LINES 48-55

.. code-block:: default



    data_small = data[..., :3]
    bvals_small = bvals[:3]
    bvecs_small = bvecs[:3]
    gtab = gradient_table(bvals_small, bvecs_small)








.. GENERATED FROM PYTHON SOURCE LINES 56-58

Start motion correction of our reduced DWI dataset(between-volumes motion
correction).

.. GENERATED FROM PYTHON SOURCE LINES 58-62

.. code-block:: default



    data_corrected, reg_affines = motion_correction(data_small, gtab, affine)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]




.. GENERATED FROM PYTHON SOURCE LINES 63-64

Save our DWI dataset corrected to a new Nifti file.

.. GENERATED FROM PYTHON SOURCE LINES 64-69

.. code-block:: default



    save_nifti('motion_correction.nii.gz', data_corrected.get_fdata(),
               data_corrected.affine)








.. GENERATED FROM PYTHON SOURCE LINES 70-78

References
----------

.. [JenkinsonSmith01] Jenkinson, M., Smith, S., 2001. A global optimisation
   method for robust affine registration of brain images. Med Image Anal 5
   (2), 143â€“56.

.. include:: ../links_names.inc


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 1 minutes  37.137 seconds)


.. _sphx_glr_download_examples_built_04_preprocessing_motion_correction.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: motion_correction.py <motion_correction.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: motion_correction.ipynb <motion_correction.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
