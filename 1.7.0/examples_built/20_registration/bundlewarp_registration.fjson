{"parents": [{"link": "../../../documentation/", "title": "Documentation"}, {"link": "../../", "title": "Examples"}, {"link": "../", "title": "Registration"}], "prev": {"link": "../syn_registration_2d/", "title": "Symmetric Diffeomorphic Registration in 2D"}, "next": {"link": "../affine_registration_masks/", "title": "Affine Registration with Masks"}, "title": "Nonrigid Bundle Registration with BundleWarp", "meta": null, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-20-registration-bundlewarp-registration-py\"><span class=\"std std-ref\">here</span></a>\nto download the full example code</p>\n</div>\n<section class=\"sphx-glr-example-title\" id=\"nonrigid-bundle-registration-with-bundlewarp\">\n<span id=\"sphx-glr-examples-built-20-registration-bundlewarp-registration-py\"></span><h1>Nonrigid Bundle Registration with BundleWarp<a class=\"headerlink\" href=\"#nonrigid-bundle-registration-with-bundlewarp\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>This example explains how you can nonlinearly register two bundles from two\ndifferent subjects directly in the space of streamlines <a class=\"reference internal\" href=\"#chandio23\" id=\"id1\"><span>[Chandio23]</span></a>, <a class=\"reference internal\" href=\"../../../interfaces/buan_flow/#chandio20\" id=\"id2\"><span>[Chandio20]</span></a>.</p>\n<p>To show the concept, we will use two pre-saved uncinate fasciculus bundles. The\nalgorithm used here is called BundleWarp, streamline-based nonlinear\nregistration of white matter tracts <a class=\"reference internal\" href=\"#chandio23\" id=\"id3\"><span>[Chandio23]</span></a>.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">os.path</span> <span class=\"kn\">import</span> <span class=\"n\">join</span> <span class=\"k\">as</span> <span class=\"n\">pjoin</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.align.streamwarp</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">bundlewarp</span><span class=\"p\">,</span> <span class=\"n\">bundlewarp_vector_filed</span><span class=\"p\">,</span>\n                                   <span class=\"n\">bundlewarp_shape_analysis</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">fetch_bundle_warp_dataset</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.stateful_tractogram</span> <span class=\"kn\">import</span> <span class=\"n\">Space</span><span class=\"p\">,</span> <span class=\"n\">StatefulTractogram</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">save_tractogram</span><span class=\"p\">,</span> <span class=\"n\">load_trk</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">set_number_of_points</span><span class=\"p\">,</span> <span class=\"n\">unlist_streamlines</span><span class=\"p\">,</span>\n                                      <span class=\"n\">Streamlines</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz.streamline</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">viz_two_bundles</span><span class=\"p\">,</span> <span class=\"n\">viz_vector_field</span><span class=\"p\">,</span>\n                                 <span class=\"n\">viz_displacement_mag</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">time</span> <span class=\"kn\">import</span> <span class=\"n\">time</span>\n</pre></div>\n</div>\n<p>Let\u2019s download and loaf two uncinate fasciculus bundles in the left hemisphere\nof the brain (UF_L) available here:\n<a class=\"reference external\" href=\"https://figshare.com/articles/dataset/Test_Bundles_for_DIPY/22557733\">https://figshare.com/articles/dataset/Test_Bundles_for_DIPY/22557733</a></p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">bundle_warp_files</span> <span class=\"o\">=</span> <span class=\"n\">fetch_bundle_warp_dataset</span><span class=\"p\">()</span>\n<span class=\"n\">s_UF_L_path</span> <span class=\"o\">=</span> <span class=\"n\">pjoin</span><span class=\"p\">(</span><span class=\"n\">bundle_warp_files</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"s1\">&#39;s_UF_L.trk&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">m_UF_L_path</span> <span class=\"o\">=</span> <span class=\"n\">pjoin</span><span class=\"p\">(</span><span class=\"n\">bundle_warp_files</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"s1\">&#39;m_UF_L.trk&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">uf_subj1</span> <span class=\"o\">=</span> <span class=\"n\">load_trk</span><span class=\"p\">(</span><span class=\"n\">s_UF_L_path</span><span class=\"p\">,</span> <span class=\"n\">reference</span><span class=\"o\">=</span><span class=\"s2\">&quot;same&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">bbox_valid_check</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">streamlines</span>\n<span class=\"n\">uf_subj2</span> <span class=\"o\">=</span> <span class=\"n\">load_trk</span><span class=\"p\">(</span><span class=\"n\">m_UF_L_path</span><span class=\"p\">,</span> <span class=\"n\">reference</span><span class=\"o\">=</span><span class=\"s2\">&quot;same&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">bbox_valid_check</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">streamlines</span>\n</pre></div>\n</div>\n<p>Let\u2019s resample the streamlines so that they both have the same number of points\nper streamline. Here we will use 20 points.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">static</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">set_number_of_points</span><span class=\"p\">(</span><span class=\"n\">uf_subj1</span><span class=\"p\">,</span> <span class=\"mi\">20</span><span class=\"p\">))</span>\n<span class=\"n\">moving</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">set_number_of_points</span><span class=\"p\">(</span><span class=\"n\">uf_subj2</span><span class=\"p\">,</span> <span class=\"mi\">20</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<p>We call <code class=\"docutils literal notranslate\"><span class=\"pre\">uf_subj2</span></code> a moving bundle as it will be nonlinearly aligned with\n<code class=\"docutils literal notranslate\"><span class=\"pre\">uf_subj1</span></code> (static) bundle. Here is how this is done.</p>\n<p>Let\u2019s visualize static bundle in red and moving in green before registration.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">viz_two_bundles</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">moving</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"o\">=</span><span class=\"s2\">&quot;static_and_moving.png&quot;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_001.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_001.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>BundleWarp method provides a unique ability to either partially or fully deform\na moving bundle by the use of a single regularization parameter alpha.\nalpha controls the trade-off between regularizing the deformation and having\npoints match very closely. The lower the value of alpha, the more closely the\nbundles would match.</p>\n<p>Let\u2019s partially deform bundle by setting alpha=0.5.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">start</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"p\">()</span>\n<span class=\"n\">deformed_bundle</span><span class=\"p\">,</span> <span class=\"n\">moving_aligned</span><span class=\"p\">,</span> <span class=\"n\">distances</span><span class=\"p\">,</span> <span class=\"n\">match_pairs</span><span class=\"p\">,</span> <span class=\"n\">warp_map</span> <span class=\"o\">=</span> <span class=\"n\">bundlewarp</span><span class=\"p\">(</span>\n                               <span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">moving</span><span class=\"p\">,</span> <span class=\"n\">alpha</span><span class=\"o\">=</span><span class=\"mf\">0.5</span><span class=\"p\">,</span> <span class=\"n\">beta</span><span class=\"o\">=</span><span class=\"mi\">20</span><span class=\"p\">,</span> <span class=\"n\">max_iter</span><span class=\"o\">=</span><span class=\"mi\">15</span><span class=\"p\">)</span>\n<span class=\"n\">end</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"p\">()</span>\n\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;time taken by BundleWarp registration in seconds = &quot;</span><span class=\"p\">,</span> <span class=\"n\">end</span><span class=\"o\">-</span><span class=\"n\">start</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>time taken by BundleWarp registration in seconds =  3.4690449237823486\n</pre></div>\n</div>\n<p>Let\u2019s visualize static bundle in red and moved (warped) in green. Note: You can\nset interactive=True in visualization functions throughout this tutorial if you\nprefer to get interactive visualization window.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">viz_two_bundles</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">deformed_bundle</span><span class=\"p\">,</span>\n                <span class=\"n\">fname</span><span class=\"o\">=</span><span class=\"s2\">&quot;static_and_partially_deformed.png&quot;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_002.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_002.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Let\u2019s visualize linearly moved bundle in blue and nonlinearly moved bundle in\ngreen to see BundleWarp registration improvement over linear SLR registration.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">viz_two_bundles</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">,</span> <span class=\"n\">deformed_bundle</span><span class=\"p\">,</span>\n                <span class=\"n\">fname</span><span class=\"o\">=</span><span class=\"s2\">&quot;linearly_and_nonlinearly_moved.png&quot;</span><span class=\"p\">,</span> <span class=\"n\">c1</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_003.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_003.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Now, let\u2019s visualize deformation vector field generated by BundleWarp.\nThis shows us visually where and how much and in what directions deformations\nwere added by BundleWarp.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">directions</span><span class=\"p\">,</span> <span class=\"n\">colors</span> <span class=\"o\">=</span> <span class=\"n\">bundlewarp_vector_filed</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">,</span>\n                                                      <span class=\"n\">deformed_bundle</span><span class=\"p\">)</span>\n\n<span class=\"n\">points_aligned</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">unlist_streamlines</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Visualizing just the vector field.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fname</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;partially_vectorfield.png&quot;</span>\n<span class=\"n\">viz_vector_field</span><span class=\"p\">(</span><span class=\"n\">points_aligned</span><span class=\"p\">,</span> <span class=\"n\">directions</span><span class=\"p\">,</span> <span class=\"n\">colors</span><span class=\"p\">,</span> <span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_004.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_004.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Let\u2019s visualize vector field over linearly moved bundle. This will show how\nmuch deformations were introduced after linear registration.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fname</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;partially_vectorfield_over_linearly_moved.png&quot;</span>\n<span class=\"n\">viz_vector_field</span><span class=\"p\">(</span><span class=\"n\">points_aligned</span><span class=\"p\">,</span> <span class=\"n\">directions</span><span class=\"p\">,</span> <span class=\"n\">colors</span><span class=\"p\">,</span> <span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"p\">,</span>\n                 <span class=\"n\">moving_aligned</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_005.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_005.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>We can also visualize the magnitude of deformations in mm mapped over affinely\nmoved bundle. It shows which streamlines were deformed the most after affine\nregistration.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fname</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;partially_deformation_magnitude_over_linearly_moved.png&quot;</span>\n<span class=\"n\">viz_displacement_mag</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">,</span> <span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"p\">,</span> <span class=\"n\">interactive</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_006.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_006.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Saving partially warped bundle.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">new_tractogram</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">deformed_bundle</span><span class=\"p\">,</span> <span class=\"n\">m_UF_L_path</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_tractogram</span><span class=\"p\">(</span><span class=\"n\">new_tractogram</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partially_deformed_bundle.trk&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">bbox_valid_check</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>True\n</pre></div>\n</div>\n<p>Let\u2019s fully deform the moving bundle by setting alpha &lt;= 0.01</p>\n<p>We will use MDF distances computed and returned by previous run of BundleWarp\nmethod. This will save computation time.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">start</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"p\">()</span>\n<span class=\"n\">deformed_bundle2</span><span class=\"p\">,</span> <span class=\"n\">moving_aligned</span><span class=\"p\">,</span> <span class=\"n\">distances</span><span class=\"p\">,</span> <span class=\"n\">match_pairs</span><span class=\"p\">,</span> <span class=\"n\">warp_map</span> <span class=\"o\">=</span> <span class=\"n\">bundlewarp</span><span class=\"p\">(</span>\n        <span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">moving</span><span class=\"p\">,</span> <span class=\"n\">dist</span><span class=\"o\">=</span><span class=\"n\">distances</span><span class=\"p\">,</span> <span class=\"n\">alpha</span><span class=\"o\">=</span><span class=\"mf\">0.001</span><span class=\"p\">,</span> <span class=\"n\">beta</span><span class=\"o\">=</span><span class=\"mi\">20</span><span class=\"p\">)</span>\n<span class=\"n\">end</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"p\">()</span>\n\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"s2\">&quot;time taken by BundleWarp registration in seconds = &quot;</span><span class=\"p\">,</span> <span class=\"n\">end</span><span class=\"o\">-</span><span class=\"n\">start</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>/Users/skoudoro/devel/dipy/dipy/align/streamwarp.py:116: UserWarning: Using alpha&lt;=0.01 will result in extreme deformations\n  warnings.warn(&quot;Using alpha&lt;=0.01 will result in extreme deformations&quot;)\nusing pre-computed distances\ntime taken by BundleWarp registration in seconds =  2.5579748153686523\n</pre></div>\n</div>\n<p>Let\u2019s visualize static bundle in red and moved (completely warped) in green.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">viz_two_bundles</span><span class=\"p\">(</span><span class=\"n\">static</span><span class=\"p\">,</span> <span class=\"n\">deformed_bundle2</span><span class=\"p\">,</span>\n                <span class=\"n\">fname</span><span class=\"o\">=</span><span class=\"s2\">&quot;static_and_fully_deformed.png&quot;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_007.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_007.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Now, let\u2019s visualize the deformation vector field generated by BundleWarp.\nThis shows us visually where and how much and in what directions deformations\nwere added by BundleWarp to perfectly warp moving bundle to look like static.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">directions</span><span class=\"p\">,</span> <span class=\"n\">colors</span> <span class=\"o\">=</span> <span class=\"n\">bundlewarp_vector_filed</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">,</span>\n                                                      <span class=\"n\">deformed_bundle2</span><span class=\"p\">)</span>\n\n<span class=\"n\">points_aligned</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">unlist_streamlines</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Visualizing just the vector field.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fname</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;fully_vectorfield.png&quot;</span>\n<span class=\"n\">viz_vector_field</span><span class=\"p\">(</span><span class=\"n\">points_aligned</span><span class=\"p\">,</span> <span class=\"n\">directions</span><span class=\"p\">,</span> <span class=\"n\">colors</span><span class=\"p\">,</span> <span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_008.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_008.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Let\u2019s visualize vector field over linearly moved bundle. This will show how\nmuch deformations were introduced after linear registration by fully deforming\nthe moving bundle.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fname</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;fully_vectorfield_over_linearly_moved.png&quot;</span>\n<span class=\"n\">viz_vector_field</span><span class=\"p\">(</span><span class=\"n\">points_aligned</span><span class=\"p\">,</span> <span class=\"n\">directions</span><span class=\"p\">,</span> <span class=\"n\">colors</span><span class=\"p\">,</span> <span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"p\">,</span>\n                 <span class=\"n\">moving_aligned</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_009.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_009.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>Let\u2019s visualize the magnitude of deformations in mm mapped over affinely moved\nbundle. It shows which streamlines were deformed the most after affine\nregistration.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fname</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;fully_deformation_magnitude_over_linearly_moved.png&quot;</span>\n<span class=\"n\">viz_displacement_mag</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">,</span> <span class=\"n\">offsets</span><span class=\"p\">,</span> <span class=\"n\">fname</span><span class=\"p\">,</span> <span class=\"n\">interactive</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_bundlewarp_registration_010.png\" srcset=\"../../_images/sphx_glr_bundlewarp_registration_010.png\" alt=\"bundlewarp registration\" class = \"sphx-glr-single-img\"/><p>We can also perform bundle shape difference analysis using the displacement\nfield generated by fully warping the moving bundle to look exactly like static\nbundle. Here, we plot bundle shape profile using BUAN. Bundle shape profile\nshows the average magnitude of deformations along the length of the bundle.\nSegments where we observe higher deformations are the areas where two bundles\ndiffer the most in shape.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"o\">=</span> <span class=\"n\">bundlewarp_shape_analysis</span><span class=\"p\">(</span><span class=\"n\">moving_aligned</span><span class=\"p\">,</span> <span class=\"n\">deformed_bundle</span><span class=\"p\">,</span> <span class=\"n\">no_disks</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span>\n                                 <span class=\"n\">plotting</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>Saving fully warped bundle.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">new_tractogram</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">deformed_bundle2</span><span class=\"p\">,</span> <span class=\"n\">m_UF_L_path</span><span class=\"p\">,</span>\n                                    <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_tractogram</span><span class=\"p\">(</span><span class=\"n\">new_tractogram</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fully_deformed_bundle.trk&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">bbox_valid_check</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>True\n</pre></div>\n</div>\n<section id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<div role=\"list\" class=\"citation-list\">\n<div class=\"citation\" id=\"chandio23\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span>Chandio23<span class=\"fn-bracket\">]</span></span>\n<span class=\"backrefs\">(<a role=\"doc-backlink\" href=\"#id1\">1</a>,<a role=\"doc-backlink\" href=\"#id3\">2</a>)</span>\n<p>Chandio et al., \u201cBundleWarp, streamline-based nonlinear\nregistration of white matter tracts.\u201d\nbioRxiv (2023): 2023-01.</p>\n</div>\n<div class=\"citation\" id=\"chandio20\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id2\">Chandio20</a><span class=\"fn-bracket\">]</span></span>\n<p>Chandio and Garyfallidis., \u201cStND: Streamline-based non-rigid\npartial-deformation tractography registration.\u201d Medical\nImaging Meets NeurIPS (2020).</p>\n</div>\n</div>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 0 minutes  10.694 seconds)</p>\n<div class=\"sphx-glr-footer sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-20-registration-bundlewarp-registration-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/eb94b82308b9f3f62ddd41b989420f99/bundlewarp_registration.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">bundlewarp_registration.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/bfbaaff8eb3f964bb3d321a23ef0710c/bundlewarp_registration.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">bundlewarp_registration.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</section>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["examples_built/20_registration/affine_registration_masks", "Affine Registration with Masks", "N", "next"], ["examples_built/20_registration/syn_registration_2d", "Symmetric Diffeomorphic Registration in 2D", "P", "previous"]], "sourcename": "examples_built/20_registration/bundlewarp_registration.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Nonrigid Bundle Registration with BundleWarp</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/20_registration/bundlewarp_registration", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}