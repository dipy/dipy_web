{"parents": [{"link": "../../../documentation/", "title": "Documentation"}, {"link": "../../", "title": "Examples"}, {"link": "../", "title": "Reconstruction"}], "prev": {"link": "../reconst_sh/", "title": "Signal Reconstruction Using Spherical Harmonics"}, "next": {"link": "../reconst_ivim/", "title": "Intravoxel incoherent motion"}, "title": "Using the free water elimination model to remove DTI free water contamination", "meta": null, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-07-reconstruction-reconst-fwdti-py\"><span class=\"std std-ref\">here</span></a>\nto download the full example code</p>\n</div>\n<section class=\"sphx-glr-example-title\" id=\"using-the-free-water-elimination-model-to-remove-dti-free-water-contamination\">\n<span id=\"sphx-glr-examples-built-07-reconstruction-reconst-fwdti-py\"></span><h1>Using the free water elimination model to remove DTI free water contamination<a class=\"headerlink\" href=\"#using-the-free-water-elimination-model-to-remove-dti-free-water-contamination\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>As shown previously (see <span class=\"xref std std-ref\">example_reconst_dti</span>), the diffusion tensor model\nis a simple way to characterize diffusion anisotropy. However, in regions near\nthe ventricles and parenchyma, anisotropy can be underestimated by partial\nvolume effects of the cerebral spinal fluid (CSF). This free water contamination\ncan particularly corrupt Diffusion Tensor Imaging analysis of microstructural\nchanges when different groups of subjects show different brain morphology (e.g.\nbrain ventricle enlargement associated with brain tissue atrophy that occurs in\nseveral brain pathologies and aging).</p>\n<p>A way to remove this free water influences is to expand the DTI model to take\ninto account an extra compartment representing the contributions of free water\ndiffusion <a class=\"reference internal\" href=\"#pasternak2009\" id=\"id1\"><span>[Pasternak2009]</span></a>. The expression of the expanded DTI model is shown\nbelow:</p>\n<div class=\"math notranslate nohighlight\">\n\\[S(\\mathbf{g}, b) = S_0(1-f)e^{-b\\mathbf{g}^T \\mathbf{D}\n\\mathbf{g}}+S_0fe^{-b D_{iso}}\\]</div>\n<p>where <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}\\)</span> and <span class=\"math notranslate nohighlight\">\\(b\\)</span> are diffusion gradient direction and weighted (more\ninformation see <span class=\"xref std std-ref\">example_reconst_dti</span>), <span class=\"math notranslate nohighlight\">\\(S(\\mathbf{g}, b)\\)</span> is the\ndiffusion-weighted signal measured, <span class=\"math notranslate nohighlight\">\\(S_0\\)</span> is the signal in a measurement with no\ndiffusion weighting, <span class=\"math notranslate nohighlight\">\\(\\mathbf{D}\\)</span> is the diffusion tensor, <span class=\"math notranslate nohighlight\">\\(f\\)</span> the volume\nfraction of the free water component, and <span class=\"math notranslate nohighlight\">\\(D_{iso}\\)</span> is the isotropic value of\nthe free water diffusion (normally set to <span class=\"math notranslate nohighlight\">\\(3.0  imes 10^{-3} mm^{2}s^{-1}\\)</span>).</p>\n<p>In this example, we show how to process a diffusion weighting dataset using an\nadapted version of the free water elimination proposed by <a class=\"reference internal\" href=\"#hoy2014\" id=\"id2\"><span>[Hoy2014]</span></a>.</p>\n<p>The full details of Dipy\u2019s free water DTI implementation was published in\n<a class=\"reference internal\" href=\"#henriques2017\" id=\"id3\"><span>[Henriques2017]</span></a>. Please cite this work if you use this algorithm.</p>\n<p>Let\u2019s start by importing the relevant modules:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">import</span> <span class=\"nn\">dipy.reconst.fwdti</span> <span class=\"k\">as</span> <span class=\"nn\">fwdti</span>\n<span class=\"kn\">import</span> <span class=\"nn\">dipy.reconst.dti</span> <span class=\"k\">as</span> <span class=\"nn\">dti</span>\n<span class=\"kn\">import</span> <span class=\"nn\">matplotlib.pyplot</span> <span class=\"k\">as</span> <span class=\"nn\">plt</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">fetch_hbn</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os.path</span> <span class=\"k\">as</span> <span class=\"nn\">op</span>\n<span class=\"kn\">import</span> <span class=\"nn\">nibabel</span> <span class=\"k\">as</span> <span class=\"nn\">nib</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">gradient_table</span>\n</pre></div>\n</div>\n<p>Without spatial constrains the free water elimination model cannot be solved\nin data acquired from one non-zero b-value <a class=\"reference internal\" href=\"#hoy2014\" id=\"id4\"><span>[Hoy2014]</span></a>. Therefore, here we\ndownload a dataset that was acquired with multiple b-values.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">data_path</span> <span class=\"o\">=</span> <span class=\"n\">fetch_hbn</span><span class=\"p\">([</span><span class=\"s2\">&quot;NDARAA948VFH&quot;</span><span class=\"p\">])[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n<span class=\"n\">dwi_path</span> <span class=\"o\">=</span> <span class=\"n\">op</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n       <span class=\"n\">data_path</span><span class=\"p\">,</span> <span class=\"s2\">&quot;derivatives&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;qsiprep&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;sub-NDARAA948VFH&quot;</span><span class=\"p\">,</span>\n       <span class=\"s2\">&quot;ses-HBNsiteRU&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;dwi&quot;</span><span class=\"p\">)</span>\n\n<span class=\"n\">img</span> <span class=\"o\">=</span> <span class=\"n\">nib</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">op</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n       <span class=\"n\">dwi_path</span><span class=\"p\">,</span>\n       <span class=\"s2\">&quot;sub-NDARAA948VFH_ses-HBNsiteRU_acq-64dir_space-T1w_desc-preproc_dwi.nii.gz&quot;</span><span class=\"p\">))</span>\n\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span>\n       <span class=\"n\">op</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">dwi_path</span><span class=\"p\">,</span>\n<span class=\"s2\">&quot;sub-NDARAA948VFH_ses-HBNsiteRU_acq-64dir_space-T1w_desc-preproc_dwi.bval&quot;</span><span class=\"p\">),</span>\n       <span class=\"n\">op</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">dwi_path</span><span class=\"p\">,</span>\n<span class=\"s2\">&quot;sub-NDARAA948VFH_ses-HBNsiteRU_acq-64dir_space-T1w_desc-preproc_dwi.bvec&quot;</span><span class=\"p\">))</span>\n\n<span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">asarray</span><span class=\"p\">(</span><span class=\"n\">img</span><span class=\"o\">.</span><span class=\"n\">dataobj</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The free water DTI model can take some minutes to process the full data set.\nThus, we use a brain mask that was calculated during pre-processing, to remove\nthe background of the image and avoid unnecessary calculations.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">mask_img</span> <span class=\"o\">=</span> <span class=\"n\">nib</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span>\n       <span class=\"n\">op</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">dwi_path</span><span class=\"p\">,</span>\n<span class=\"s2\">&quot;sub-NDARAA948VFH_ses-HBNsiteRU_acq-64dir_space-T1w_desc-brain_mask.nii.gz&quot;</span><span class=\"p\">))</span>\n</pre></div>\n</div>\n<p>Moreover, for illustration purposes we process only one slice of the data.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">mask</span> <span class=\"o\">=</span> <span class=\"n\">mask_img</span><span class=\"o\">.</span><span class=\"n\">get_fdata</span><span class=\"p\">()</span>\n\n<span class=\"n\">data_small</span> <span class=\"o\">=</span> <span class=\"n\">data</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">50</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">]</span>\n<span class=\"n\">mask_small</span> <span class=\"o\">=</span> <span class=\"n\">mask</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">50</span><span class=\"p\">:</span><span class=\"mi\">51</span><span class=\"p\">]</span>\n</pre></div>\n</div>\n<p>The free water elimination model fit can then be initialized by instantiating\na FreeWaterTensorModel class object:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fwdtimodel</span> <span class=\"o\">=</span> <span class=\"n\">fwdti</span><span class=\"o\">.</span><span class=\"n\">FreeWaterTensorModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The data can then be fitted using the <code class=\"docutils literal notranslate\"><span class=\"pre\">fit</span></code> function of the defined model\nobject:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fwdtifit</span> <span class=\"o\">=</span> <span class=\"n\">fwdtimodel</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">mask_small</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>  0%|          | 0/5148.0 [00:00&lt;?, ?it/s]\n  1%|1         | 76/5148.0 [00:00&lt;00:06, 752.96it/s]\n  3%|3         | 161/5148.0 [00:00&lt;00:06, 805.77it/s]\n  5%|4         | 242/5148.0 [00:00&lt;00:06, 790.45it/s]\n  6%|6         | 322/5148.0 [00:00&lt;00:06, 775.86it/s]\n  8%|7         | 405/5148.0 [00:00&lt;00:05, 794.43it/s]\n 10%|9         | 493/5148.0 [00:00&lt;00:05, 821.23it/s]\n 11%|#1        | 579/5148.0 [00:00&lt;00:05, 831.67it/s]\n 13%|#2        | 666/5148.0 [00:00&lt;00:05, 843.53it/s]\n 15%|#4        | 751/5148.0 [00:00&lt;00:05, 842.83it/s]\n 16%|#6        | 839/5148.0 [00:01&lt;00:05, 852.91it/s]\n 18%|#7        | 925/5148.0 [00:01&lt;00:04, 853.56it/s]\n 20%|#9        | 1011/5148.0 [00:01&lt;00:04, 853.76it/s]\n 21%|##1       | 1097/5148.0 [00:01&lt;00:04, 850.94it/s]\n 23%|##2       | 1183/5148.0 [00:01&lt;00:04, 842.55it/s]/opt/homebrew/Caskroom/miniforge/base/envs/dipy-39-x86/lib/python3.9/site-packages/scipy/optimize/_minpack_py.py:492: RuntimeWarning: Number of calls to function has reached maxfev = 1800.\n  warnings.warn(errors[info][0], RuntimeWarning)\n\n 25%|##4       | 1268/5148.0 [00:01&lt;00:05, 759.44it/s]\n 26%|##6       | 1346/5148.0 [00:01&lt;00:05, 711.05it/s]\n 28%|##7       | 1419/5148.0 [00:01&lt;00:05, 692.93it/s]\n 29%|##9       | 1503/5148.0 [00:01&lt;00:04, 731.21it/s]\n 31%|###       | 1589/5148.0 [00:02&lt;00:04, 765.05it/s]\n 32%|###2      | 1671/5148.0 [00:02&lt;00:04, 779.87it/s]\n 34%|###4      | 1757/5148.0 [00:02&lt;00:04, 801.64it/s]\n 36%|###5      | 1838/5148.0 [00:02&lt;00:04, 751.72it/s]\n 37%|###7      | 1923/5148.0 [00:02&lt;00:04, 778.72it/s]\n 39%|###9      | 2010/5148.0 [00:02&lt;00:03, 802.31it/s]\n 41%|####      | 2097/5148.0 [00:02&lt;00:03, 819.46it/s]\n 42%|####2     | 2180/5148.0 [00:02&lt;00:03, 819.16it/s]\n 44%|####3     | 2264/5148.0 [00:02&lt;00:03, 824.85it/s]\n 46%|####5     | 2347/5148.0 [00:02&lt;00:03, 823.75it/s]\n 47%|####7     | 2430/5148.0 [00:03&lt;00:03, 825.47it/s]\n 49%|####8     | 2513/5148.0 [00:03&lt;00:03, 821.90it/s]\n 50%|#####     | 2596/5148.0 [00:03&lt;00:03, 706.51it/s]\n 52%|#####1    | 2670/5148.0 [00:03&lt;00:03, 639.60it/s]\n 54%|#####3    | 2757/5148.0 [00:03&lt;00:03, 696.39it/s]\n 55%|#####5    | 2840/5148.0 [00:03&lt;00:03, 731.79it/s]\n 57%|#####6    | 2922/5148.0 [00:03&lt;00:02, 751.63it/s]\n 58%|#####8    | 3005/5148.0 [00:03&lt;00:02, 771.12it/s]\n 60%|#####9    | 3084/5148.0 [00:03&lt;00:02, 774.30it/s]\n 62%|######1   | 3169/5148.0 [00:04&lt;00:02, 794.99it/s]\n 63%|######3   | 3254/5148.0 [00:04&lt;00:02, 808.65it/s]\n 65%|######4   | 3339/5148.0 [00:04&lt;00:02, 820.50it/s]\n 67%|######6   | 3425/5148.0 [00:04&lt;00:02, 831.52it/s]\n 68%|######8   | 3509/5148.0 [00:04&lt;00:01, 832.64it/s]\n 70%|######9   | 3593/5148.0 [00:04&lt;00:01, 833.14it/s]\n 71%|#######1  | 3677/5148.0 [00:04&lt;00:01, 833.01it/s]\n 73%|#######3  | 3761/5148.0 [00:04&lt;00:01, 754.61it/s]\n 75%|#######4  | 3838/5148.0 [00:04&lt;00:01, 704.50it/s]\n 76%|#######5  | 3910/5148.0 [00:05&lt;00:01, 686.72it/s]\n 77%|#######7  | 3980/5148.0 [00:05&lt;00:01, 671.27it/s]\n 79%|#######8  | 4064/5148.0 [00:05&lt;00:01, 715.48it/s]\n 80%|########  | 4142/5148.0 [00:05&lt;00:01, 733.54it/s]\n 82%|########2 | 4227/5148.0 [00:05&lt;00:01, 763.40it/s]\n 84%|########3 | 4312/5148.0 [00:05&lt;00:01, 785.73it/s]\n 85%|########5 | 4394/5148.0 [00:05&lt;00:00, 794.26it/s]\n 87%|########7 | 4482/5148.0 [00:05&lt;00:00, 818.89it/s]\n 89%|########8 | 4567/5148.0 [00:05&lt;00:00, 824.37it/s]\n 90%|######### | 4652/5148.0 [00:05&lt;00:00, 830.22it/s]\n 92%|#########1| 4736/5148.0 [00:06&lt;00:00, 811.69it/s]\n 94%|#########3| 4818/5148.0 [00:06&lt;00:00, 795.24it/s]\n 95%|#########5| 4902/5148.0 [00:06&lt;00:00, 805.89it/s]\n 97%|#########6| 4986/5148.0 [00:06&lt;00:00, 813.48it/s]\n 99%|#########8| 5072/5148.0 [00:06&lt;00:00, 824.82it/s]\n100%|##########| 5148/5148.0 [00:06&lt;00:00, 784.36it/s]\n</pre></div>\n</div>\n<p>This 2-steps procedure will create a FreeWaterTensorFit object which contains\nall the diffusion tensor statistics free for free water contamination. Below\nwe extract the fractional anisotropy (FA) and the mean diffusivity (MD) of the\nfree water diffusion tensor.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">FA</span> <span class=\"o\">=</span> <span class=\"n\">fwdtifit</span><span class=\"o\">.</span><span class=\"n\">fa</span>\n<span class=\"n\">MD</span> <span class=\"o\">=</span> <span class=\"n\">fwdtifit</span><span class=\"o\">.</span><span class=\"n\">md</span>\n</pre></div>\n</div>\n<p>For comparison we also compute the same standard measures processed by the\nstandard DTI model</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">dtimodel</span> <span class=\"o\">=</span> <span class=\"n\">dti</span><span class=\"o\">.</span><span class=\"n\">TensorModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)</span>\n\n<span class=\"n\">dtifit</span> <span class=\"o\">=</span> <span class=\"n\">dtimodel</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data_small</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">mask_small</span><span class=\"p\">)</span>\n\n<span class=\"n\">dti_FA</span> <span class=\"o\">=</span> <span class=\"n\">dtifit</span><span class=\"o\">.</span><span class=\"n\">fa</span>\n<span class=\"n\">dti_MD</span> <span class=\"o\">=</span> <span class=\"n\">dtifit</span><span class=\"o\">.</span><span class=\"n\">md</span>\n</pre></div>\n</div>\n<p>Below the FA values for both free water elimination DTI model and standard DTI\nmodel are plotted in panels A and B, while the respective MD values are plotted\nin panels D and E. For a better visualization of the effect of the free water\ncorrection, the differences between these two metrics are shown in panels C and\nE. In addition to the standard diffusion statistics, the estimated volume\nfraction of the free water contamination is shown on panel G.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig1</span><span class=\"p\">,</span> <span class=\"n\">ax</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">subplots</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span> <span class=\"mi\">6</span><span class=\"p\">),</span>\n                        <span class=\"n\">subplot_kw</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;xticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[],</span> <span class=\"s1\">&#39;yticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[]})</span>\n\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">subplots_adjust</span><span class=\"p\">(</span><span class=\"n\">hspace</span><span class=\"o\">=</span><span class=\"mf\">0.3</span><span class=\"p\">,</span> <span class=\"n\">wspace</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;A) fwDTI FA&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;B) standard DTI FA&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">FAdiff</span> <span class=\"o\">=</span> <span class=\"nb\">abs</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">])</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FAdiff</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;C) FA difference&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">axis</span><span class=\"p\">(</span><span class=\"s1\">&#39;off&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mf\">2.5e-3</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">4</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;D) fwDTI MD&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">dti_MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mf\">2.5e-3</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">5</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;E) standard DTI MD&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">MDdiff</span> <span class=\"o\">=</span> <span class=\"nb\">abs</span><span class=\"p\">(</span><span class=\"n\">MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">dti_MD</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">])</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">MDdiff</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mf\">2.5e-3</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;F) MD difference&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">F</span> <span class=\"o\">=</span> <span class=\"n\">fwdtifit</span><span class=\"o\">.</span><span class=\"n\">f</span>\n\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">F</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;G) free water volume&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">()</span>\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;In_vivo_free_water_DTI_and_standard_DTI_measures.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_reconst_fwdti_001.png\" srcset=\"../../_images/sphx_glr_reconst_fwdti_001.png\" alt=\"reconst fwdti\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id5\">\n<img alt=\"examples_built/07_reconstruction/In_vivo_free_water_DTI_and_standard_DTI_measures.png\" src=\"examples_built/07_reconstruction/In_vivo_free_water_DTI_and_standard_DTI_measures.png\" />\n<figcaption>\n<p><span class=\"caption-text\">In vivo diffusion measures obtain from the free water DTI and standard\nDTI. The values of Fractional Anisotropy for the free water DTI model and\nstandard DTI model and their difference are shown in the upper panels (A-C),\nwhile respective MD values are shown in the lower panels (D-F). In addition\nthe free water volume fraction estimated from the fwDTI model is shown in\npanel G.</span><a class=\"headerlink\" href=\"#id5\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p>From the figure, one can observe that the free water elimination model\nproduces in general higher values of FA and lower values of MD than the\nstandard DTI model. These differences in FA and MD estimation are expected\ndue to the suppression of the free water isotropic diffusion components.\nUnexpected high amplitudes of FA are however observed in the periventricular\ngray matter. This is a known artefact of regions associated to voxels with high\nwater volume fraction (i.e. voxels containing basically CSF). We are able to\nremove this problematic voxels by excluding all FA values associated with\nmeasured volume fractions above a reasonable threshold of 0.7:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">FA</span><span class=\"p\">[</span><span class=\"n\">F</span> <span class=\"o\">&gt;</span> <span class=\"mf\">0.7</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">dti_FA</span><span class=\"p\">[</span><span class=\"n\">F</span> <span class=\"o\">&gt;</span> <span class=\"mf\">0.7</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n</pre></div>\n</div>\n<p>Above we reproduce the plots of the in vivo FA from the two DTI fits and where\nwe can see that the inflated FA values were practically removed:</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">fig1</span><span class=\"p\">,</span> <span class=\"n\">ax</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">subplots</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"n\">figsize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">9</span><span class=\"p\">,</span> <span class=\"mi\">3</span><span class=\"p\">),</span>\n                        <span class=\"n\">subplot_kw</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;xticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[],</span> <span class=\"s1\">&#39;yticks&#39;</span><span class=\"p\">:</span> <span class=\"p\">[]})</span>\n\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">subplots_adjust</span><span class=\"p\">(</span><span class=\"n\">hspace</span><span class=\"o\">=</span><span class=\"mf\">0.3</span><span class=\"p\">,</span> <span class=\"n\">wspace</span><span class=\"o\">=</span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;A) fwDTI FA&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;B) standard DTI FA&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">FAdiff</span> <span class=\"o\">=</span> <span class=\"nb\">abs</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">-</span> <span class=\"n\">dti_FA</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"mi\">0</span><span class=\"p\">])</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">FAdiff</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">vmin</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">vmax</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">ax</span><span class=\"o\">.</span><span class=\"n\">flat</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">set_title</span><span class=\"p\">(</span><span class=\"s1\">&#39;C) FA difference&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">()</span>\n<span class=\"n\">fig1</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;In_vivo_free_water_DTI_and_standard_DTI_corrected.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_reconst_fwdti_002.png\" srcset=\"../../_images/sphx_glr_reconst_fwdti_002.png\" alt=\"reconst fwdti\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id6\">\n<img alt=\"examples_built/07_reconstruction/In_vivo_free_water_DTI_and_standard_DTI_corrected.png\" src=\"examples_built/07_reconstruction/In_vivo_free_water_DTI_and_standard_DTI_corrected.png\" />\n<figcaption>\n<p><span class=\"caption-text\">In vivo FA measures obtain from the free water DTI (A) and standard\nDTI (B) and their difference (C). Problematic inflated FA values of the\nimages were removed by dismissing voxels above a volume fraction threshold\nof 0.7.</span><a class=\"headerlink\" href=\"#id6\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<section id=\"references\">\n<h2>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<div role=\"list\" class=\"citation-list\">\n<div class=\"citation\" id=\"pasternak2009\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id1\">Pasternak2009</a><span class=\"fn-bracket\">]</span></span>\n<p>Pasternak, O., Sochen, N., Gur, Y., Intrator, N., Assaf, Y.,\n2009. Free water elimination and mapping from diffusion MRI. Magn. Reson.\nMed. 62(3): 717-30. doi: 10.1002/mrm.22055.</p>\n</div>\n<div class=\"citation\" id=\"hoy2014\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span>Hoy2014<span class=\"fn-bracket\">]</span></span>\n<span class=\"backrefs\">(<a role=\"doc-backlink\" href=\"#id2\">1</a>,<a role=\"doc-backlink\" href=\"#id4\">2</a>)</span>\n<p>Hoy, A.R., Koay, C.G., Kecskemeti, S.R., Alexander, A.L., 2014.\nOptimization of a free water elimination two-compartmental model for\ndiffusion tensor imaging. NeuroImage 103, 323-333. doi:\n10.1016/j.neuroimage.2014.09.053</p>\n</div>\n<div class=\"citation\" id=\"henriques2017\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id3\">Henriques2017</a><span class=\"fn-bracket\">]</span></span>\n<p>Henriques, R.N., Rokem, A., Garyfallidis, E., St-Jean, S.,\nPeterson E.T., Correia, M.M., 2017. [Re] Optimization of a free water\nelimination two-compartment model for diffusion tensor imaging.\nReScience volume 3, issue 1, article number 2</p>\n</div>\n</div>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 0 minutes  11.685 seconds)</p>\n<div class=\"sphx-glr-footer sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-07-reconstruction-reconst-fwdti-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/2bfab52cda956f0ebbdc10d5a35f0e01/reconst_fwdti.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">reconst_fwdti.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/8ef4ee9106cd9760355824857eb1a468/reconst_fwdti.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">reconst_fwdti.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</section>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["examples_built/07_reconstruction/reconst_ivim", "Intravoxel incoherent motion", "N", "next"], ["examples_built/07_reconstruction/reconst_sh", "Signal Reconstruction Using Spherical Harmonics", "P", "previous"]], "sourcename": "examples_built/07_reconstruction/reconst_fwdti.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Using the free water elimination model to remove DTI free water contamination</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/07_reconstruction/reconst_fwdti", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}