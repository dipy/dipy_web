{"parents": [{"link": "../../../documentation/", "title": "Documentation"}, {"link": "../../", "title": "Examples"}, {"link": "../", "title": "Fiber Tracking"}], "prev": {"link": "../tracking_probabilistic/", "title": "An introduction to the Probabilistic Direction Getter"}, "next": {"link": "../linear_fascicle_evaluation/", "title": "Linear fascicle evaluation (LiFE)"}, "title": "Particle Filtering Tractography", "meta": null, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-13-fiber-tracking-tracking-pft-py\"><span class=\"std std-ref\">here</span></a>\nto download the full example code</p>\n</div>\n<section class=\"sphx-glr-example-title\" id=\"particle-filtering-tractography\">\n<span id=\"sphx-glr-examples-built-13-fiber-tracking-tracking-pft-py\"></span><h1>Particle Filtering Tractography<a class=\"headerlink\" href=\"#particle-filtering-tractography\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>Particle Filtering Tractography (PFT) <a class=\"reference internal\" href=\"../tracking_stopping_criterion/#girard2014\" id=\"id1\"><span>[Girard2014]</span></a> uses tissue partial\nvolume estimation (PVE) to reconstruct trajectories connecting the gray matter,\nand not incorrectly stopping in the white matter or in the corticospinal fluid.\nIt relies on a stopping criterion that identifies the tissue where the\nstreamline stopped. If the streamline correctly stopped in the gray matter, the\ntrajectory is kept. If the streamline incorrectly stopped in the white matter\nor in the corticospinal fluid, PFT uses anatomical information to find an\nalternative streamline segment to extend the trajectory. When this segment is\nfound, the tractography continues until the streamline correctly stops in the\ngray matter.</p>\n<p>PFT finds an alternative streamline segment whenever the stopping criterion\nreturns a position classified as \u2018INVALIDPOINT\u2019.</p>\n<p>This example is an extension of <span class=\"xref std std-ref\">example_tracking_probabilistic</span> and\n<span class=\"xref std std-ref\">example_tracking_stopping_criterion</span> examples. We begin by loading the\ndata, fitting a Constrained Spherical Deconvolution (CSD) reconstruction\nmodel, creating the probabilistic direction getter and defining the seeds.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">gradient_table</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">get_fnames</span><span class=\"p\">,</span> <span class=\"n\">default_sphere</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">ProbabilisticDirectionGetter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">read_bvals_bvecs</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.image</span> <span class=\"kn\">import</span> <span class=\"n\">load_nifti</span><span class=\"p\">,</span> <span class=\"n\">load_nifti_data</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.stateful_tractogram</span> <span class=\"kn\">import</span> <span class=\"n\">Space</span><span class=\"p\">,</span> <span class=\"n\">StatefulTractogram</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">save_trk</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">,</span>\n                                   <span class=\"n\">auto_response_ssst</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local_tracking</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">LocalTracking</span><span class=\"p\">,</span>\n                                          <span class=\"n\">ParticleFilteringTracking</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">Streamlines</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking</span> <span class=\"kn\">import</span> <span class=\"n\">utils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"kn\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"p\">,</span> <span class=\"n\">has_fury</span>\n\n<span class=\"c1\"># Enables/disables interactive visualization</span>\n<span class=\"n\">interactive</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n<span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_hardi&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">label_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_labels&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">f_pve_csf</span><span class=\"p\">,</span> <span class=\"n\">f_pve_gm</span><span class=\"p\">,</span> <span class=\"n\">f_pve_wm</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_pve_maps&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">return_img</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">label_fname</span><span class=\"p\">)</span>\n<span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span> <span class=\"o\">=</span> <span class=\"n\">read_bvals_bvecs</span><span class=\"p\">(</span><span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span><span class=\"p\">)</span>\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span><span class=\"p\">)</span>\n\n<span class=\"n\">pve_csf_data</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">f_pve_csf</span><span class=\"p\">)</span>\n<span class=\"n\">pve_gm_data</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">f_pve_gm</span><span class=\"p\">)</span>\n<span class=\"n\">pve_wm_data</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">voxel_size</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">f_pve_wm</span><span class=\"p\">,</span> <span class=\"n\">return_voxsize</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n<span class=\"n\">shape</span> <span class=\"o\">=</span> <span class=\"n\">labels</span><span class=\"o\">.</span><span class=\"n\">shape</span>\n\n<span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">ratio</span> <span class=\"o\">=</span> <span class=\"n\">auto_response_ssst</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">roi_radii</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">fa_thr</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n<span class=\"n\">csd_model</span> <span class=\"o\">=</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit</span> <span class=\"o\">=</span> <span class=\"n\">csd_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">pve_wm_data</span><span class=\"p\">)</span>\n\n<span class=\"n\">dg</span> <span class=\"o\">=</span> <span class=\"n\">ProbabilisticDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span><span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span><span class=\"p\">,</span>\n                                               <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">20.</span><span class=\"p\">,</span>\n                                               <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n\n<span class=\"n\">seed_mask</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">seed_mask</span><span class=\"p\">[</span><span class=\"n\">pve_wm_data</span> <span class=\"o\">&lt;</span> <span class=\"mf\">0.5</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">seeds</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">seeds_from_mask</span><span class=\"p\">(</span><span class=\"n\">seed_mask</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">density</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>  0%|          | 0/77848.12 [00:00&lt;?, ?it/s]\n  0%|          | 328/77848.12 [00:00&lt;00:23, 3275.48it/s]\n  1%|          | 736/77848.12 [00:00&lt;00:20, 3747.66it/s]\n  1%|1         | 1149/77848.12 [00:00&lt;00:19, 3918.51it/s]\n  2%|1         | 1556/77848.12 [00:00&lt;00:19, 3974.95it/s]\n  3%|2         | 1987/77848.12 [00:00&lt;00:18, 4094.68it/s]\n  3%|3         | 2425/77848.12 [00:00&lt;00:18, 4188.89it/s]\n  4%|3         | 2844/77848.12 [00:00&lt;00:17, 4184.84it/s]\n  4%|4         | 3289/77848.12 [00:00&lt;00:17, 4268.92it/s]\n  5%|4         | 3716/77848.12 [00:00&lt;00:17, 4243.35it/s]\n  5%|5         | 4161/77848.12 [00:01&lt;00:17, 4306.74it/s]\n  6%|5         | 4592/77848.12 [00:01&lt;00:17, 4272.31it/s]\n  7%|6         | 5069/77848.12 [00:01&lt;00:16, 4422.22it/s]\n  7%|7         | 5512/77848.12 [00:01&lt;00:16, 4331.54it/s]\n  8%|7         | 5979/77848.12 [00:01&lt;00:16, 4431.27it/s]\n  8%|8         | 6423/77848.12 [00:01&lt;00:16, 4396.01it/s]\n  9%|8         | 6895/77848.12 [00:01&lt;00:15, 4489.39it/s]\n  9%|9         | 7359/77848.12 [00:01&lt;00:15, 4532.86it/s]\n 10%|#         | 7813/77848.12 [00:01&lt;00:15, 4437.13it/s]\n 11%|#         | 8290/77848.12 [00:01&lt;00:15, 4534.88it/s]\n 11%|#1        | 8745/77848.12 [00:02&lt;00:15, 4530.19it/s]\n 12%|#1        | 9199/77848.12 [00:02&lt;00:15, 4452.22it/s]\n 12%|#2        | 9657/77848.12 [00:02&lt;00:15, 4489.64it/s]\n 13%|#2        | 10108/77848.12 [00:02&lt;00:15, 4494.55it/s]\n 14%|#3        | 10558/77848.12 [00:02&lt;00:15, 4450.98it/s]\n 14%|#4        | 11019/77848.12 [00:02&lt;00:14, 4496.84it/s]\n 15%|#4        | 11485/77848.12 [00:02&lt;00:14, 4543.90it/s]\n 15%|#5        | 11940/77848.12 [00:02&lt;00:14, 4516.88it/s]\n 16%|#5        | 12413/77848.12 [00:02&lt;00:14, 4577.74it/s]\n 17%|#6        | 12886/77848.12 [00:02&lt;00:14, 4622.98it/s]\n 17%|#7        | 13349/77848.12 [00:03&lt;00:14, 4553.26it/s]\n 18%|#7        | 13834/77848.12 [00:03&lt;00:13, 4638.52it/s]\n 18%|#8        | 14308/77848.12 [00:03&lt;00:13, 4667.23it/s]\n 19%|#8        | 14775/77848.12 [00:03&lt;00:13, 4648.42it/s]\n 20%|#9        | 15241/77848.12 [00:03&lt;00:13, 4647.29it/s]\n 20%|##        | 15716/77848.12 [00:03&lt;00:13, 4677.68it/s]\n 21%|##        | 16184/77848.12 [00:03&lt;00:13, 4650.73it/s]\n 21%|##1       | 16650/77848.12 [00:03&lt;00:13, 4550.42it/s]\n 22%|##1       | 17108/77848.12 [00:03&lt;00:13, 4557.25it/s]\n 23%|##2       | 17566/77848.12 [00:03&lt;00:13, 4563.63it/s]\n 23%|##3       | 18030/77848.12 [00:04&lt;00:13, 4584.69it/s]\n 24%|##3       | 18489/77848.12 [00:04&lt;00:13, 4524.44it/s]\n 24%|##4       | 18980/77848.12 [00:04&lt;00:12, 4638.04it/s]\n 25%|##4       | 19455/77848.12 [00:04&lt;00:12, 4670.78it/s]\n 26%|##5       | 19943/77848.12 [00:04&lt;00:12, 4731.50it/s]\n 26%|##6       | 20417/77848.12 [00:04&lt;00:12, 4704.50it/s]\n 27%|##6       | 20903/77848.12 [00:04&lt;00:11, 4750.56it/s]\n 27%|##7       | 21380/77848.12 [00:04&lt;00:11, 4755.95it/s]\n 28%|##8       | 21856/77848.12 [00:04&lt;00:11, 4745.99it/s]\n 29%|##8       | 22331/77848.12 [00:04&lt;00:11, 4729.57it/s]\n 29%|##9       | 22805/77848.12 [00:05&lt;00:11, 4730.20it/s]\n 30%|##9       | 23289/77848.12 [00:05&lt;00:11, 4761.46it/s]\n 31%|###       | 23766/77848.12 [00:05&lt;00:11, 4737.84it/s]\n 31%|###1      | 24240/77848.12 [00:05&lt;00:11, 4686.25it/s]\n 32%|###1      | 24738/77848.12 [00:05&lt;00:11, 4772.43it/s]\n 32%|###2      | 25225/77848.12 [00:05&lt;00:10, 4800.78it/s]\n 33%|###3      | 25706/77848.12 [00:05&lt;00:11, 4735.36it/s]\n 34%|###3      | 26180/77848.12 [00:05&lt;00:11, 4691.12it/s]\n 34%|###4      | 26687/77848.12 [00:05&lt;00:10, 4801.79it/s]\n 35%|###4      | 27168/77848.12 [00:05&lt;00:10, 4798.77it/s]\n 36%|###5      | 27649/77848.12 [00:06&lt;00:10, 4765.82it/s]\n 36%|###6      | 28126/77848.12 [00:06&lt;00:10, 4737.31it/s]\n 37%|###6      | 28602/77848.12 [00:06&lt;00:10, 4738.88it/s]\n 37%|###7      | 29082/77848.12 [00:06&lt;00:10, 4753.67it/s]\n 38%|###7      | 29558/77848.12 [00:06&lt;00:10, 4707.20it/s]\n 39%|###8      | 30040/77848.12 [00:06&lt;00:10, 4738.22it/s]\n 39%|###9      | 30514/77848.12 [00:06&lt;00:10, 4659.14it/s]\n 40%|###9      | 30999/77848.12 [00:06&lt;00:09, 4712.71it/s]\n 40%|####      | 31471/77848.12 [00:06&lt;00:09, 4684.65it/s]\n 41%|####1     | 31941/77848.12 [00:06&lt;00:09, 4687.75it/s]\n 42%|####1     | 32424/77848.12 [00:07&lt;00:09, 4728.27it/s]\n 42%|####2     | 32900/77848.12 [00:07&lt;00:09, 4735.87it/s]\n 43%|####2     | 33382/77848.12 [00:07&lt;00:09, 4760.65it/s]\n 44%|####3     | 33866/77848.12 [00:07&lt;00:09, 4779.81it/s]\n 44%|####4     | 34345/77848.12 [00:07&lt;00:09, 4752.62it/s]\n 45%|####4     | 34821/77848.12 [00:07&lt;00:09, 4690.27it/s]\n 45%|####5     | 35307/77848.12 [00:07&lt;00:08, 4739.60it/s]\n 46%|####5     | 35782/77848.12 [00:07&lt;00:08, 4733.10it/s]\n 47%|####6     | 36256/77848.12 [00:07&lt;00:08, 4714.30it/s]\n 47%|####7     | 36734/77848.12 [00:08&lt;00:08, 4730.56it/s]\n 48%|####7     | 37208/77848.12 [00:08&lt;00:08, 4664.92it/s]\n 48%|####8     | 37683/77848.12 [00:08&lt;00:08, 4688.25it/s]\n 49%|####9     | 38153/77848.12 [00:08&lt;00:08, 4633.54it/s]\n 50%|####9     | 38617/77848.12 [00:08&lt;00:08, 4599.04it/s]\n 50%|#####     | 39094/77848.12 [00:08&lt;00:08, 4647.51it/s]\n 51%|#####     | 39559/77848.12 [00:08&lt;00:08, 4619.02it/s]\n 51%|#####1    | 40024/77848.12 [00:08&lt;00:08, 4627.99it/s]\n 52%|#####2    | 40487/77848.12 [00:08&lt;00:08, 4627.13it/s]\n 53%|#####2    | 40950/77848.12 [00:08&lt;00:08, 4557.44it/s]\n 53%|#####3    | 41406/77848.12 [00:09&lt;00:08, 4477.63it/s]\n 54%|#####3    | 41868/77848.12 [00:09&lt;00:07, 4519.34it/s]\n 54%|#####4    | 42321/77848.12 [00:09&lt;00:07, 4508.05it/s]\n 55%|#####4    | 42773/77848.12 [00:09&lt;00:07, 4470.91it/s]\n 56%|#####5    | 43237/77848.12 [00:09&lt;00:07, 4519.43it/s]\n 56%|#####6    | 43690/77848.12 [00:09&lt;00:07, 4451.13it/s]\n 57%|#####6    | 44160/77848.12 [00:09&lt;00:07, 4523.02it/s]\n 57%|#####7    | 44618/77848.12 [00:09&lt;00:07, 4537.75it/s]\n 58%|#####7    | 45073/77848.12 [00:09&lt;00:07, 4467.34it/s]\n 58%|#####8    | 45536/77848.12 [00:09&lt;00:07, 4513.54it/s]\n 59%|#####9    | 45988/77848.12 [00:10&lt;00:07, 4494.50it/s]\n 60%|#####9    | 46438/77848.12 [00:10&lt;00:07, 4481.39it/s]\n 60%|######    | 46887/77848.12 [00:10&lt;00:06, 4456.35it/s]\n 61%|######    | 47371/77848.12 [00:10&lt;00:06, 4568.43it/s]\n 61%|######1   | 47832/77848.12 [00:10&lt;00:06, 4577.97it/s]\n 62%|######2   | 48290/77848.12 [00:10&lt;00:06, 4543.56it/s]\n 63%|######2   | 48754/77848.12 [00:10&lt;00:06, 4568.64it/s]\n 63%|######3   | 49211/77848.12 [00:10&lt;00:06, 4547.56it/s]\n 64%|######3   | 49666/77848.12 [00:10&lt;00:06, 4524.37it/s]\n 64%|######4   | 50119/77848.12 [00:10&lt;00:06, 4519.65it/s]\n 65%|######4   | 50574/77848.12 [00:11&lt;00:06, 4527.58it/s]\n 66%|######5   | 51027/77848.12 [00:11&lt;00:05, 4477.93it/s]\n 66%|######6   | 51501/77848.12 [00:11&lt;00:05, 4554.98it/s]\n 67%|######6   | 51959/77848.12 [00:11&lt;00:05, 4562.00it/s]\n 67%|######7   | 52416/77848.12 [00:11&lt;00:05, 4512.09it/s]\n 68%|######7   | 52868/77848.12 [00:11&lt;00:05, 4474.64it/s]\n 69%|######8   | 53357/77848.12 [00:11&lt;00:05, 4596.65it/s]\n 69%|######9   | 53831/77848.12 [00:11&lt;00:05, 4639.00it/s]\n 70%|######9   | 54296/77848.12 [00:11&lt;00:05, 4614.24it/s]\n 70%|#######   | 54762/77848.12 [00:11&lt;00:04, 4626.76it/s]\n 71%|#######   | 55226/77848.12 [00:12&lt;00:04, 4629.02it/s]\n 72%|#######1  | 55714/77848.12 [00:12&lt;00:04, 4703.09it/s]\n 72%|#######2  | 56185/77848.12 [00:12&lt;00:04, 4673.14it/s]\n 73%|#######2  | 56657/77848.12 [00:12&lt;00:04, 4682.88it/s]\n 73%|#######3  | 57126/77848.12 [00:12&lt;00:04, 4667.55it/s]\n 74%|#######3  | 57606/77848.12 [00:12&lt;00:04, 4706.03it/s]\n 75%|#######4  | 58082/77848.12 [00:12&lt;00:04, 4717.48it/s]\n 75%|#######5  | 58554/77848.12 [00:12&lt;00:04, 4658.31it/s]\n 76%|#######5  | 59021/77848.12 [00:12&lt;00:04, 4626.47it/s]\n 76%|#######6  | 59484/77848.12 [00:12&lt;00:03, 4599.70it/s]\n 77%|#######7  | 59970/77848.12 [00:13&lt;00:03, 4675.44it/s]\n 78%|#######7  | 60460/77848.12 [00:13&lt;00:03, 4742.11it/s]\n 78%|#######8  | 60935/77848.12 [00:13&lt;00:03, 4705.77it/s]\n 79%|#######8  | 61416/77848.12 [00:13&lt;00:03, 4735.04it/s]\n 80%|#######9  | 61890/77848.12 [00:13&lt;00:03, 4656.00it/s]\n 80%|########  | 62395/77848.12 [00:13&lt;00:03, 4770.84it/s]\n 81%|########  | 62884/77848.12 [00:13&lt;00:03, 4803.85it/s]\n 81%|########1 | 63365/77848.12 [00:13&lt;00:03, 4749.19it/s]\n 82%|########2 | 63841/77848.12 [00:13&lt;00:02, 4747.35it/s]\n 83%|########2 | 64316/77848.12 [00:14&lt;00:02, 4682.89it/s]\n 83%|########3 | 64816/77848.12 [00:14&lt;00:02, 4775.25it/s]\n 84%|########3 | 65301/77848.12 [00:14&lt;00:02, 4797.00it/s]\n 84%|########4 | 65781/77848.12 [00:14&lt;00:02, 4777.22it/s]\n 85%|########5 | 66264/77848.12 [00:14&lt;00:02, 4791.02it/s]\n 86%|########5 | 66744/77848.12 [00:14&lt;00:02, 4738.19it/s]\n 86%|########6 | 67251/77848.12 [00:14&lt;00:02, 4835.39it/s]\n 87%|########7 | 67735/77848.12 [00:14&lt;00:02, 4812.44it/s]\n 88%|########7 | 68217/77848.12 [00:14&lt;00:02, 4729.76it/s]\n 88%|########8 | 68691/77848.12 [00:14&lt;00:01, 4694.17it/s]\n 89%|########8 | 69161/77848.12 [00:15&lt;00:01, 4666.97it/s]\n 89%|########9 | 69671/77848.12 [00:15&lt;00:01, 4793.15it/s]\n 90%|######### | 70151/77848.12 [00:15&lt;00:01, 4770.00it/s]\n 91%|######### | 70629/77848.12 [00:15&lt;00:01, 4744.51it/s]\n 91%|#########1| 71104/77848.12 [00:15&lt;00:01, 4663.03it/s]\n 92%|#########1| 71603/77848.12 [00:15&lt;00:01, 4757.96it/s]\n 93%|#########2| 72080/77848.12 [00:15&lt;00:01, 4740.47it/s]\n 93%|#########3| 72555/77848.12 [00:15&lt;00:01, 4661.64it/s]\n 94%|#########3| 73022/77848.12 [00:15&lt;00:01, 4652.75it/s]\n 94%|#########4| 73493/77848.12 [00:15&lt;00:00, 4668.08it/s]\n 95%|#########5| 73976/77848.12 [00:16&lt;00:00, 4714.13it/s]\n 96%|#########5| 74448/77848.12 [00:16&lt;00:00, 4694.95it/s]\n 96%|#########6| 74918/77848.12 [00:16&lt;00:00, 4661.05it/s]\n 97%|#########6| 75385/77848.12 [00:16&lt;00:00, 4613.83it/s]\n 97%|#########7| 75870/77848.12 [00:16&lt;00:00, 4680.32it/s]\n 98%|#########8| 76339/77848.12 [00:16&lt;00:00, 4671.93it/s]\n 99%|#########8| 76807/77848.12 [00:16&lt;00:00, 4649.92it/s]\n 99%|#########9| 77273/77848.12 [00:16&lt;00:00, 4596.37it/s]\n100%|#########9| 77773/77848.12 [00:16&lt;00:00, 4713.75it/s]\n78245it [00:16, 4701.16it/s]\n78716it [00:17, 4685.78it/s]\n79185it [00:17, 4623.35it/s]\n79711it [00:17, 4807.82it/s]\n80193it [00:17, 4722.56it/s]\n80667it [00:17, 4725.88it/s]\n81140it [00:17, 4616.00it/s]\n81658it [00:17, 4779.55it/s]\n82137it [00:17, 4755.44it/s]\n82614it [00:17, 4752.95it/s]\n83090it [00:17, 4665.21it/s]\n83582it [00:18, 4739.35it/s]\n84057it [00:18, 4710.25it/s]\n84529it [00:18, 4634.61it/s]\n84993it [00:18, 4619.70it/s]\n85478it [00:18, 4686.55it/s]\n85947it [00:18, 4685.53it/s]\n86416it [00:18, 4625.71it/s]\n86905it [00:18, 4702.44it/s]\n87376it [00:18, 4651.64it/s]\n87842it [00:19, 4557.37it/s]\n88323it [00:19, 4629.07it/s]\n88787it [00:19, 4491.90it/s]\n89238it [00:19, 4494.58it/s]\n89702it [00:19, 4534.82it/s]\n90157it [00:19, 4441.59it/s]\n90634it [00:19, 4536.45it/s]\n91089it [00:19, 4454.18it/s]\n91552it [00:19, 4504.55it/s]\n92004it [00:19, 4433.40it/s]\n92451it [00:20, 4442.09it/s]\n92899it [00:20, 4450.96it/s]\n93345it [00:20, 4337.77it/s]\n93780it [00:20, 4339.22it/s]\n94215it [00:20, 4226.23it/s]\n94645it [00:20, 4247.00it/s]\n95071it [00:20, 4177.53it/s]\n95490it [00:20, 4165.31it/s]\n95907it [00:20, 4126.55it/s]\n96320it [00:20, 4060.14it/s]\n96727it [00:21, 4025.54it/s]\n96989it [00:21, 4582.95it/s]\n</pre></div>\n</div>\n<section id=\"cmc-act-stopping-criterion\">\n<h2>CMC/ACT Stopping Criterion<a class=\"headerlink\" href=\"#cmc-act-stopping-criterion\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>Continuous map criterion (CMC) <a class=\"reference internal\" href=\"../tracking_stopping_criterion/#girard2014\" id=\"id2\"><span>[Girard2014]</span></a> and Anatomically-constrained\ntractography (ACT) <a class=\"reference internal\" href=\"../tracking_stopping_criterion/#smith2012\" id=\"id3\"><span>[Smith2012]</span></a> both uses PVEs information from\nanatomical images to determine when the tractography stops.\nBoth stopping criterion use a trilinear interpolation\nat the tracking position. CMC stopping criterion uses a probability derived\nfrom the PVE maps to determine if the streamline reaches a \u2018valid\u2019 or \u2018invalid\u2019\nregion. ACT uses a fixed threshold on the PVE maps. Both stopping criterion can\nbe used in conjunction with PFT. In this example, we used CMC.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.stopping_criterion</span> <span class=\"kn\">import</span> <span class=\"n\">CmcStoppingCriterion</span>\n\n<span class=\"n\">voxel_size</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">average</span><span class=\"p\">(</span><span class=\"n\">voxel_size</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"mi\">4</span><span class=\"p\">])</span>\n<span class=\"n\">step_size</span> <span class=\"o\">=</span> <span class=\"mf\">0.2</span>\n\n<span class=\"n\">cmc_criterion</span> <span class=\"o\">=</span> <span class=\"n\">CmcStoppingCriterion</span><span class=\"o\">.</span><span class=\"n\">from_pve</span><span class=\"p\">(</span><span class=\"n\">pve_wm_data</span><span class=\"p\">,</span>\n                                              <span class=\"n\">pve_gm_data</span><span class=\"p\">,</span>\n                                              <span class=\"n\">pve_csf_data</span><span class=\"p\">,</span>\n                                              <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"n\">step_size</span><span class=\"p\">,</span>\n                                              <span class=\"n\">average_voxel_size</span><span class=\"o\">=</span><span class=\"n\">voxel_size</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># Particle Filtering Tractography</span>\n<span class=\"n\">pft_streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">ParticleFilteringTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">cmc_criterion</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">max_cross</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"n\">step_size</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">maxlen</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">pft_back_tracking_dist</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">pft_front_tracking_dist</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">particle_count</span><span class=\"o\">=</span><span class=\"mi\">15</span><span class=\"p\">,</span>\n                                                     <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">pft_streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_pft.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_pft.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_pft_001.png\" srcset=\"../../_images/sphx_glr_tracking_pft_001.png\" alt=\"tracking pft\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id4\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_pft.png\" src=\"examples_built/13_fiber_tracking/tractogram_pft.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using particle filtering tractography</strong></span><a class=\"headerlink\" href=\"#id4\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"c1\"># Local Probabilistic Tractography</span>\n<span class=\"n\">prob_streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                          <span class=\"n\">cmc_criterion</span><span class=\"p\">,</span>\n                                          <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                          <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                          <span class=\"n\">max_cross</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n                                          <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"n\">step_size</span><span class=\"p\">,</span>\n                                          <span class=\"n\">maxlen</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span>\n                                          <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">prob_streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_probabilistic_cmc.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_probabilistic_cmc.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_pft_002.png\" srcset=\"../../_images/sphx_glr_tracking_pft_002.png\" alt=\"tracking pft\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id5\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_probabilistic_cmc.png\" src=\"examples_built/13_fiber_tracking/tractogram_probabilistic_cmc.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using probabilistic tractography</strong></span><a class=\"headerlink\" href=\"#id5\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<section id=\"references\">\n<h3>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<div role=\"list\" class=\"citation-list\">\n<div class=\"citation\" id=\"girard2014\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span>Girard2014<span class=\"fn-bracket\">]</span></span>\n<span class=\"backrefs\">(<a role=\"doc-backlink\" href=\"#id1\">1</a>,<a role=\"doc-backlink\" href=\"#id2\">2</a>)</span>\n<p>Girard, G., Whittingstall, K., Deriche, R., &amp; Descoteaux, M.\nTowards quantitative connectivity analysis: reducing tractography biases.\nNeuroImage, 98, 266-278, 2014.</p>\n</div>\n<div class=\"citation\" id=\"smith2012\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id3\">Smith2012</a><span class=\"fn-bracket\">]</span></span>\n<p>Smith, R. E., Tournier, J.-D., Calamante, F., &amp; Connelly, A.\nAnatomically-constrained tractography: Improved diffusion MRI\nstreamlines tractography through effective use of anatomical\ninformation. NeuroImage, 63(3), 1924-1938, 2012.</p>\n</div>\n</div>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 1 minutes  8.115 seconds)</p>\n<div class=\"sphx-glr-footer sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-13-fiber-tracking-tracking-pft-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/1ebbdd45fc417fd57ce5882e4a5cb2f4/tracking_pft.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">tracking_pft.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/2aceb3df4a3a92aab0c39aa085b50054/tracking_pft.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">tracking_pft.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</section>\n</section>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["examples_built/13_fiber_tracking/linear_fascicle_evaluation", "Linear fascicle evaluation (LiFE)", "N", "next"], ["examples_built/13_fiber_tracking/tracking_probabilistic", "An introduction to the Probabilistic Direction Getter", "P", "previous"]], "sourcename": "examples_built/13_fiber_tracking/tracking_pft.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Particle Filtering Tractography</a><ul>\n<li><a class=\"reference internal\" href=\"#cmc-act-stopping-criterion\">CMC/ACT Stopping Criterion</a><ul>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/13_fiber_tracking/tracking_pft", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}