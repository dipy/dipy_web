{"parents": [{"link": "../../../documentation/", "title": "Documentation"}, {"link": "../../", "title": "Examples"}, {"link": "../", "title": "Fiber Tracking"}], "prev": {"link": "../linear_fascicle_evaluation/", "title": "Linear fascicle evaluation (LiFE)"}, "next": {"link": "../../17_streamline_analysis/", "title": "Streamlines Analysis and Connectivity"}, "title": "Using Various Stopping Criterion for Tractography", "meta": null, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-13-fiber-tracking-tracking-stopping-criterion-py\"><span class=\"std std-ref\">here</span></a>\nto download the full example code</p>\n</div>\n<section class=\"sphx-glr-example-title\" id=\"using-various-stopping-criterion-for-tractography\">\n<span id=\"sphx-glr-examples-built-13-fiber-tracking-tracking-stopping-criterion-py\"></span><h1>Using Various Stopping Criterion for Tractography<a class=\"headerlink\" href=\"#using-various-stopping-criterion-for-tractography\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>The stopping criterion determines if the tracking stops or continues at each\ntracking position. The tracking stops when it reaches an ending region\n(e.g. low FA, gray matter or corticospinal fluid regions) or exits the image\nboundaries. The tracking also stops if the direction getter has no direction\nto follow.</p>\n<p>Each stopping criterion determines if the stopping is \u2018valid\u2019 or\n\u2018invalid\u2019. A streamline is \u2018valid\u2019 when the stopping criterion determines if\nthe streamline stops in a position classified as \u2018ENDPOINT\u2019 or \u2018OUTSIDEIMAGE\u2019.\nA streamline is \u2018invalid\u2019 when it stops in a position classified as\n\u2018TRACKPOINT\u2019 or \u2018INVALIDPOINT\u2019. These conditions are described below. The\n\u2018LocalTracking\u2019 generator can be set to output all generated streamlines\nor only the \u2018valid\u2019 ones. See Girard et al. (2004) <a class=\"reference internal\" href=\"#girard2014\" id=\"id1\"><span>[Girard2014]</span></a> and Smith et\nal.(2012) <a class=\"reference internal\" href=\"#smith2012\" id=\"id2\"><span>[Smith2012]</span></a> for more details on these methods.</p>\n<p>This example is an extension of the\n<span class=\"xref std std-ref\">example_tracking_deterministic</span> example. We begin by loading the\ndata, creating a seeding mask from white matter voxels of the corpus callosum,\nfitting a Constrained Spherical Deconvolution (CSD) reconstruction\nmodel and creating the maximum deterministic direction getter.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">import</span> <span class=\"nn\">matplotlib.pyplot</span> <span class=\"k\">as</span> <span class=\"nn\">plt</span>\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">gradient_table</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">get_fnames</span><span class=\"p\">,</span> <span class=\"n\">default_sphere</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">DeterministicMaximumDirectionGetter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">read_bvals_bvecs</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.image</span> <span class=\"kn\">import</span> <span class=\"n\">load_nifti</span><span class=\"p\">,</span> <span class=\"n\">load_nifti_data</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">save_trk</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.stateful_tractogram</span> <span class=\"kn\">import</span> <span class=\"n\">Space</span><span class=\"p\">,</span> <span class=\"n\">StatefulTractogram</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">,</span>\n                                   <span class=\"n\">auto_response_ssst</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.dti</span> <span class=\"kn\">import</span> <span class=\"n\">fractional_anisotropy</span><span class=\"p\">,</span> <span class=\"n\">TensorModel</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking</span> <span class=\"kn\">import</span> <span class=\"n\">utils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local_tracking</span> <span class=\"kn\">import</span> <span class=\"n\">LocalTracking</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">Streamlines</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.stopping_criterion</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">ActStoppingCriterion</span><span class=\"p\">,</span>\n                                              <span class=\"n\">BinaryStoppingCriterion</span><span class=\"p\">,</span>\n                                              <span class=\"n\">ThresholdStoppingCriterion</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"kn\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"p\">,</span> <span class=\"n\">has_fury</span>\n\n\n<span class=\"c1\"># Enables/disables interactive visualization</span>\n<span class=\"n\">interactive</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n<span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_hardi&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">label_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_labels&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">f_pve_wm</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_pve_maps&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">return_img</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">label_fname</span><span class=\"p\">)</span>\n<span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span> <span class=\"o\">=</span> <span class=\"n\">read_bvals_bvecs</span><span class=\"p\">(</span><span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span><span class=\"p\">)</span>\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span><span class=\"p\">)</span>\n\n<span class=\"n\">white_matter</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">f_pve_wm</span><span class=\"p\">)</span>\n\n<span class=\"n\">seed_mask</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">seed_mask</span><span class=\"p\">[</span><span class=\"n\">white_matter</span> <span class=\"o\">&lt;</span> <span class=\"mf\">0.5</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">seeds</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">seeds_from_mask</span><span class=\"p\">(</span><span class=\"n\">seed_mask</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">density</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n\n<span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">ratio</span> <span class=\"o\">=</span> <span class=\"n\">auto_response_ssst</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">roi_radii</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">fa_thr</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n<span class=\"n\">csd_model</span> <span class=\"o\">=</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit</span> <span class=\"o\">=</span> <span class=\"n\">csd_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">white_matter</span><span class=\"p\">)</span>\n\n<span class=\"n\">dg</span> <span class=\"o\">=</span> <span class=\"n\">DeterministicMaximumDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span><span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span><span class=\"p\">,</span>\n                                                      <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">30.</span><span class=\"p\">,</span>\n                                                      <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>  0%|          | 0/77848.12 [00:00&lt;?, ?it/s]\n  0%|          | 325/77848.12 [00:00&lt;00:23, 3245.98it/s]\n  1%|          | 726/77848.12 [00:00&lt;00:20, 3692.20it/s]\n  1%|1         | 1131/77848.12 [00:00&lt;00:19, 3853.21it/s]\n  2%|1         | 1533/77848.12 [00:00&lt;00:19, 3913.37it/s]\n  3%|2         | 1953/77848.12 [00:00&lt;00:18, 4016.23it/s]\n  3%|3         | 2379/77848.12 [00:00&lt;00:18, 4097.47it/s]\n  4%|3         | 2796/77848.12 [00:00&lt;00:18, 4121.02it/s]\n  4%|4         | 3235/77848.12 [00:00&lt;00:17, 4205.35it/s]\n  5%|4         | 3656/77848.12 [00:00&lt;00:17, 4184.57it/s]\n  5%|5         | 4111/77848.12 [00:01&lt;00:17, 4293.67it/s]\n  6%|5         | 4541/77848.12 [00:01&lt;00:17, 4233.99it/s]\n  6%|6         | 4986/77848.12 [00:01&lt;00:16, 4298.53it/s]\n  7%|6         | 5417/77848.12 [00:01&lt;00:17, 4239.35it/s]\n  8%|7         | 5868/77848.12 [00:01&lt;00:16, 4318.35it/s]\n  8%|8         | 6309/77848.12 [00:01&lt;00:16, 4343.46it/s]\n  9%|8         | 6744/77848.12 [00:01&lt;00:16, 4323.03it/s]\n  9%|9         | 7213/77848.12 [00:01&lt;00:15, 4431.49it/s]\n 10%|9         | 7657/77848.12 [00:01&lt;00:16, 4354.23it/s]\n 10%|#         | 8125/77848.12 [00:01&lt;00:15, 4450.01it/s]\n 11%|#1        | 8572/77848.12 [00:02&lt;00:15, 4453.55it/s]\n 12%|#1        | 9018/77848.12 [00:02&lt;00:15, 4364.06it/s]\n 12%|#2        | 9461/77848.12 [00:02&lt;00:15, 4381.44it/s]\n 13%|#2        | 9916/77848.12 [00:02&lt;00:15, 4427.63it/s]\n 13%|#3        | 10360/77848.12 [00:02&lt;00:15, 4373.19it/s]\n 14%|#3        | 10833/77848.12 [00:02&lt;00:14, 4475.81it/s]\n 14%|#4        | 11285/77848.12 [00:02&lt;00:14, 4487.04it/s]\n 15%|#5        | 11735/77848.12 [00:02&lt;00:14, 4431.85it/s]\n 16%|#5        | 12221/77848.12 [00:02&lt;00:14, 4556.41it/s]\n 16%|#6        | 12684/77848.12 [00:02&lt;00:14, 4576.83it/s]\n 17%|#6        | 13142/77848.12 [00:03&lt;00:14, 4560.46it/s]\n 17%|#7        | 13599/77848.12 [00:03&lt;00:14, 4554.72it/s]\n 18%|#8        | 14069/77848.12 [00:03&lt;00:13, 4596.78it/s]\n 19%|#8        | 14534/77848.12 [00:03&lt;00:13, 4611.96it/s]\n 19%|#9        | 14996/77848.12 [00:03&lt;00:13, 4510.06it/s]\n 20%|#9        | 15473/77848.12 [00:03&lt;00:13, 4584.14it/s]\n 20%|##        | 15936/77848.12 [00:03&lt;00:13, 4596.07it/s]\n 21%|##1       | 16396/77848.12 [00:03&lt;00:13, 4580.06it/s]\n 22%|##1       | 16855/77848.12 [00:03&lt;00:13, 4499.52it/s]\n 22%|##2       | 17324/77848.12 [00:03&lt;00:13, 4552.76it/s]\n 23%|##2       | 17780/77848.12 [00:04&lt;00:13, 4542.67it/s]\n 23%|##3       | 18245/77848.12 [00:04&lt;00:13, 4573.53it/s]\n 24%|##4       | 18703/77848.12 [00:04&lt;00:12, 4553.52it/s]\n 25%|##4       | 19180/77848.12 [00:04&lt;00:12, 4615.20it/s]\n 25%|##5       | 19644/77848.12 [00:04&lt;00:12, 4621.00it/s]\n 26%|##5       | 20113/77848.12 [00:04&lt;00:12, 4638.97it/s]\n 26%|##6       | 20583/77848.12 [00:04&lt;00:12, 4655.61it/s]\n 27%|##7       | 21060/77848.12 [00:04&lt;00:12, 4687.25it/s]\n 28%|##7       | 21529/77848.12 [00:04&lt;00:12, 4675.84it/s]\n 28%|##8       | 21997/77848.12 [00:04&lt;00:12, 4623.24it/s]\n 29%|##8       | 22470/77848.12 [00:05&lt;00:11, 4652.59it/s]\n 29%|##9       | 22940/77848.12 [00:05&lt;00:11, 4662.91it/s]\n 30%|###       | 23408/77848.12 [00:05&lt;00:11, 4664.13it/s]\n 31%|###       | 23875/77848.12 [00:05&lt;00:11, 4650.07it/s]\n 31%|###1      | 24342/77848.12 [00:05&lt;00:11, 4653.19it/s]\n 32%|###1      | 24831/77848.12 [00:05&lt;00:11, 4721.92it/s]\n 33%|###2      | 25305/77848.12 [00:05&lt;00:11, 4723.24it/s]\n 33%|###3      | 25778/77848.12 [00:05&lt;00:11, 4666.97it/s]\n 34%|###3      | 26245/77848.12 [00:05&lt;00:11, 4641.95it/s]\n 34%|###4      | 26745/77848.12 [00:05&lt;00:10, 4747.80it/s]\n 35%|###4      | 27223/77848.12 [00:06&lt;00:10, 4755.81it/s]\n 36%|###5      | 27699/77848.12 [00:06&lt;00:10, 4701.84it/s]\n 36%|###6      | 28170/77848.12 [00:06&lt;00:10, 4619.17it/s]\n 37%|###6      | 28658/77848.12 [00:06&lt;00:10, 4692.34it/s]\n 37%|###7      | 29128/77848.12 [00:06&lt;00:10, 4687.25it/s]\n 38%|###8      | 29598/77848.12 [00:06&lt;00:10, 4655.03it/s]\n 39%|###8      | 30072/77848.12 [00:06&lt;00:10, 4678.40it/s]\n 39%|###9      | 30541/77848.12 [00:06&lt;00:10, 4619.81it/s]\n 40%|###9      | 31031/77848.12 [00:06&lt;00:09, 4702.10it/s]\n 40%|####      | 31502/77848.12 [00:06&lt;00:09, 4683.06it/s]\n 41%|####1     | 31978/77848.12 [00:07&lt;00:09, 4705.31it/s]\n 42%|####1     | 32452/77848.12 [00:07&lt;00:09, 4713.94it/s]\n 42%|####2     | 32924/77848.12 [00:07&lt;00:09, 4711.49it/s]\n 43%|####2     | 33401/77848.12 [00:07&lt;00:09, 4727.45it/s]\n 44%|####3     | 33886/77848.12 [00:07&lt;00:09, 4762.33it/s]\n 44%|####4     | 34363/77848.12 [00:07&lt;00:09, 4724.47it/s]\n 45%|####4     | 34836/77848.12 [00:07&lt;00:09, 4689.43it/s]\n 45%|####5     | 35327/77848.12 [00:07&lt;00:08, 4754.09it/s]\n 46%|####5     | 35803/77848.12 [00:07&lt;00:08, 4754.70it/s]\n 47%|####6     | 36284/77848.12 [00:07&lt;00:08, 4769.82it/s]\n 47%|####7     | 36766/77848.12 [00:08&lt;00:08, 4782.35it/s]\n 48%|####7     | 37245/77848.12 [00:08&lt;00:08, 4722.54it/s]\n 48%|####8     | 37727/77848.12 [00:08&lt;00:08, 4750.36it/s]\n 49%|####9     | 38203/77848.12 [00:08&lt;00:08, 4726.40it/s]\n 50%|####9     | 38676/77848.12 [00:08&lt;00:08, 4718.84it/s]\n 50%|#####     | 39152/77848.12 [00:08&lt;00:08, 4729.84it/s]\n 51%|#####     | 39626/77848.12 [00:08&lt;00:08, 4719.58it/s]\n 52%|#####1    | 40099/77848.12 [00:08&lt;00:08, 4696.89it/s]\n 52%|#####2    | 40569/77848.12 [00:08&lt;00:07, 4672.38it/s]\n 53%|#####2    | 41037/77848.12 [00:09&lt;00:07, 4614.61it/s]\n 53%|#####3    | 41499/77848.12 [00:09&lt;00:07, 4560.06it/s]\n 54%|#####3    | 41965/77848.12 [00:09&lt;00:07, 4589.34it/s]\n 54%|#####4    | 42425/77848.12 [00:09&lt;00:07, 4574.41it/s]\n 55%|#####5    | 42883/77848.12 [00:09&lt;00:07, 4557.72it/s]\n 56%|#####5    | 43339/77848.12 [00:09&lt;00:07, 4543.94it/s]\n 56%|#####6    | 43794/77848.12 [00:09&lt;00:07, 4524.76it/s]\n 57%|#####6    | 44247/77848.12 [00:09&lt;00:07, 4512.48it/s]\n 57%|#####7    | 44703/77848.12 [00:09&lt;00:07, 4526.25it/s]\n 58%|#####8    | 45156/77848.12 [00:09&lt;00:07, 4457.77it/s]\n 59%|#####8    | 45617/77848.12 [00:10&lt;00:07, 4501.76it/s]\n 59%|#####9    | 46068/77848.12 [00:10&lt;00:07, 4470.32it/s]\n 60%|#####9    | 46533/77848.12 [00:10&lt;00:06, 4523.11it/s]\n 60%|######    | 46986/77848.12 [00:10&lt;00:06, 4498.08it/s]\n 61%|######    | 47456/77848.12 [00:10&lt;00:06, 4554.54it/s]\n 62%|######1   | 47931/77848.12 [00:10&lt;00:06, 4611.27it/s]\n 62%|######2   | 48393/77848.12 [00:10&lt;00:06, 4523.17it/s]\n 63%|######2   | 48859/77848.12 [00:10&lt;00:06, 4562.14it/s]\n 63%|######3   | 49316/77848.12 [00:10&lt;00:06, 4539.83it/s]\n 64%|######3   | 49771/77848.12 [00:10&lt;00:06, 4525.10it/s]\n 65%|######4   | 50236/77848.12 [00:11&lt;00:06, 4561.63it/s]\n 65%|######5   | 50693/77848.12 [00:11&lt;00:05, 4563.44it/s]\n 66%|######5   | 51150/77848.12 [00:11&lt;00:05, 4547.43it/s]\n 66%|######6   | 51612/77848.12 [00:11&lt;00:05, 4568.91it/s]\n 67%|######6   | 52070/77848.12 [00:11&lt;00:05, 4570.15it/s]\n 67%|######7   | 52529/77848.12 [00:11&lt;00:05, 4574.12it/s]\n 68%|######8   | 52987/77848.12 [00:11&lt;00:05, 4556.89it/s]\n 69%|######8   | 53474/77848.12 [00:11&lt;00:05, 4649.89it/s]\n 69%|######9   | 53952/77848.12 [00:11&lt;00:05, 4687.50it/s]\n 70%|######9   | 54421/77848.12 [00:11&lt;00:05, 4660.40it/s]\n 71%|#######   | 54888/77848.12 [00:12&lt;00:04, 4637.54it/s]\n 71%|#######1  | 55383/77848.12 [00:12&lt;00:04, 4730.22it/s]\n 72%|#######1  | 55869/77848.12 [00:12&lt;00:04, 4768.24it/s]\n 72%|#######2  | 56346/77848.12 [00:12&lt;00:04, 4746.90it/s]\n 73%|#######3  | 56834/77848.12 [00:12&lt;00:04, 4784.42it/s]\n 74%|#######3  | 57313/77848.12 [00:12&lt;00:04, 4725.18it/s]\n 74%|#######4  | 57820/77848.12 [00:12&lt;00:04, 4826.20it/s]\n 75%|#######4  | 58303/77848.12 [00:12&lt;00:04, 4797.40it/s]\n 76%|#######5  | 58783/77848.12 [00:12&lt;00:03, 4782.74it/s]\n 76%|#######6  | 59262/77848.12 [00:12&lt;00:03, 4751.74it/s]\n 77%|#######6  | 59738/77848.12 [00:13&lt;00:03, 4717.42it/s]\n 77%|#######7  | 60254/77848.12 [00:13&lt;00:03, 4846.62it/s]\n 78%|#######8  | 60739/77848.12 [00:13&lt;00:03, 4797.40it/s]\n 79%|#######8  | 61220/77848.12 [00:13&lt;00:03, 4798.83it/s]\n 79%|#######9  | 61703/77848.12 [00:13&lt;00:03, 4808.04it/s]\n 80%|#######9  | 62187/77848.12 [00:13&lt;00:03, 4816.53it/s]\n 81%|########  | 62691/77848.12 [00:13&lt;00:03, 4882.43it/s]\n 81%|########1 | 63180/77848.12 [00:13&lt;00:03, 4867.85it/s]\n 82%|########1 | 63667/77848.12 [00:13&lt;00:02, 4839.43it/s]\n 82%|########2 | 64152/77848.12 [00:13&lt;00:02, 4822.92it/s]\n 83%|########3 | 64643/77848.12 [00:14&lt;00:02, 4846.41it/s]\n 84%|########3 | 65145/77848.12 [00:14&lt;00:02, 4896.20it/s]\n 84%|########4 | 65635/77848.12 [00:14&lt;00:02, 4857.18it/s]\n 85%|########4 | 66121/77848.12 [00:14&lt;00:02, 4850.13it/s]\n 86%|########5 | 66607/77848.12 [00:14&lt;00:02, 4738.72it/s]\n 86%|########6 | 67132/77848.12 [00:14&lt;00:02, 4887.16it/s]\n 87%|########6 | 67622/77848.12 [00:14&lt;00:02, 4886.15it/s]\n 87%|########7 | 68112/77848.12 [00:14&lt;00:02, 4838.24it/s]\n 88%|########8 | 68597/77848.12 [00:14&lt;00:01, 4818.12it/s]\n 89%|########8 | 69080/77848.12 [00:14&lt;00:01, 4767.38it/s]\n 89%|########9 | 69589/77848.12 [00:15&lt;00:01, 4861.54it/s]\n 90%|######### | 70076/77848.12 [00:15&lt;00:01, 4795.74it/s]\n 91%|######### | 70556/77848.12 [00:15&lt;00:01, 4764.53it/s]\n 91%|#########1| 71033/77848.12 [00:15&lt;00:01, 4713.25it/s]\n 92%|#########1| 71513/77848.12 [00:15&lt;00:01, 4736.71it/s]\n 92%|#########2| 71991/77848.12 [00:15&lt;00:01, 4746.26it/s]\n 93%|#########3| 72466/77848.12 [00:15&lt;00:01, 4699.35it/s]\n 94%|#########3| 72937/77848.12 [00:15&lt;00:01, 4699.17it/s]\n 94%|#########4| 73408/77848.12 [00:15&lt;00:00, 4656.86it/s]\n 95%|#########4| 73907/77848.12 [00:16&lt;00:00, 4754.39it/s]\n 96%|#########5| 74383/77848.12 [00:16&lt;00:00, 4738.87it/s]\n 96%|#########6| 74858/77848.12 [00:16&lt;00:00, 4719.80it/s]\n 97%|#########6| 75331/77848.12 [00:16&lt;00:00, 4649.85it/s]\n 97%|#########7| 75820/77848.12 [00:16&lt;00:00, 4718.59it/s]\n 98%|#########8| 76293/77848.12 [00:16&lt;00:00, 4702.99it/s]\n 99%|#########8| 76764/77848.12 [00:16&lt;00:00, 4683.79it/s]\n 99%|#########9| 77233/77848.12 [00:16&lt;00:00, 4614.60it/s]\n100%|#########9| 77749/77848.12 [00:16&lt;00:00, 4772.10it/s]\n78227it [00:16, 4760.73it/s]\n78704it [00:17, 4734.53it/s]\n79178it [00:17, 4664.64it/s]\n79717it [00:17, 4876.65it/s]\n80206it [00:17, 4774.87it/s]\n80685it [00:17, 4776.96it/s]\n81164it [00:17, 4657.13it/s]\n81686it [00:17, 4816.42it/s]\n82169it [00:17, 4734.83it/s]\n82644it [00:17, 4717.91it/s]\n83117it [00:17, 4633.63it/s]\n83607it [00:18, 4710.05it/s]\n84080it [00:18, 4711.70it/s]\n84552it [00:18, 4647.17it/s]\n85018it [00:18, 4617.27it/s]\n85484it [00:18, 4628.43it/s]\n85948it [00:18, 4611.56it/s]\n86410it [00:18, 4536.33it/s]\n86889it [00:18, 4609.83it/s]\n87351it [00:18, 4598.11it/s]\n87812it [00:18, 4491.33it/s]\n88288it [00:19, 4569.18it/s]\n88746it [00:19, 4477.15it/s]\n89203it [00:19, 4501.97it/s]\n89670it [00:19, 4549.66it/s]\n90126it [00:19, 4491.57it/s]\n90600it [00:19, 4562.16it/s]\n91057it [00:19, 4489.16it/s]\n91521it [00:19, 4532.81it/s]\n91975it [00:19, 4452.89it/s]\n92421it [00:20, 4395.42it/s]\n92861it [00:20, 4386.49it/s]\n93300it [00:20, 4287.92it/s]\n93743it [00:20, 4326.46it/s]\n94177it [00:20, 4232.91it/s]\n94616it [00:20, 4278.53it/s]\n95045it [00:20, 4224.65it/s]\n95468it [00:20, 4212.28it/s]\n95890it [00:20, 4167.48it/s]\n96307it [00:20, 4099.62it/s]\n96718it [00:21, 4044.62it/s]\n96989it [00:21, 4586.61it/s]\n</pre></div>\n</div>\n<section id=\"threshold-stopping-criterion\">\n<h2>Threshold Stopping Criterion<a class=\"headerlink\" href=\"#threshold-stopping-criterion\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>A scalar map can be used to define where the tracking stops. The threshold\nstopping criterion uses a scalar map to stop the tracking whenever the\ninterpolated scalar value is lower than a fixed threshold. Here, we show\nan example using the fractional anisotropy (FA) map of the DTI model.\nThe threshold stopping criterion uses a trilinear interpolation at the\ntracking position.</p>\n<p><strong>Parameters</strong></p>\n<ul class=\"simple\">\n<li><p>metric_map: numpy array [:, :, :]</p></li>\n<li><p>threshold: float</p></li>\n</ul>\n<p><strong>Stopping States</strong></p>\n<ul class=\"simple\">\n<li><p>\u2018ENDPOINT\u2019: stops at a position where metric_map &lt; threshold; the streamline</p></li>\n</ul>\n<p>reached the target stopping area.\n- \u2018OUTSIDEIMAGE\u2019: stops at a position outside of metric_map; the streamline\nreached an area outside the image where no direction data is available.\n- \u2018TRACKPOINT\u2019: stops at a position because no direction is available; the\nstreamline is stopping where metric_map &gt;= threshold, but there is no valid\ndirection to follow.\n- \u2018INVALIDPOINT\u2019: N/A.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">tensor_model</span> <span class=\"o\">=</span> <span class=\"n\">TensorModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">)</span>\n<span class=\"n\">tenfit</span> <span class=\"o\">=</span> <span class=\"n\">tensor_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">labels</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">FA</span> <span class=\"o\">=</span> <span class=\"n\">fractional_anisotropy</span><span class=\"p\">(</span><span class=\"n\">tenfit</span><span class=\"o\">.</span><span class=\"n\">evals</span><span class=\"p\">)</span>\n\n<span class=\"n\">threshold_criterion</span> <span class=\"o\">=</span> <span class=\"n\">ThresholdStoppingCriterion</span><span class=\"p\">(</span><span class=\"n\">FA</span><span class=\"p\">,</span> <span class=\"mf\">.2</span><span class=\"p\">)</span>\n\n<span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">()</span>\n<span class=\"n\">mask_fa</span> <span class=\"o\">=</span> <span class=\"n\">FA</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n<span class=\"n\">mask_fa</span><span class=\"p\">[</span><span class=\"n\">mask_fa</span> <span class=\"o\">&lt;</span> <span class=\"mf\">0.2</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">xticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">yticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">mask_fa</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"o\">//</span> <span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span>\n           <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">tight_layout</span><span class=\"p\">()</span>\n<span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;threshold_fa.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_001.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_001.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id5\">\n<img alt=\"examples_built/13_fiber_tracking/threshold_fa.png\" src=\"examples_built/13_fiber_tracking/threshold_fa.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Thresholded fractional anisotropy map.</strong></span><a class=\"headerlink\" href=\"#id5\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                     <span class=\"n\">threshold_criterion</span><span class=\"p\">,</span>\n                                     <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                     <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">,</span>\n                                     <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_probabilistic_thresh_all.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_deterministic_thresh_all.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_002.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_002.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id6\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_deterministic_thresh_all.png\" src=\"examples_built/13_fiber_tracking/tractogram_deterministic_thresh_all.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using deterministic tractography with a thresholded\nfractional anisotropy mask.</strong></span><a class=\"headerlink\" href=\"#id6\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n</section>\n<section id=\"binary-stopping-criterion\">\n<h2>Binary Stopping Criterion<a class=\"headerlink\" href=\"#binary-stopping-criterion\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>A binary mask can be used to define where the tracking stops. The binary\nstopping criterion stops the tracking whenever the tracking position is outside\nthe mask. Here, we show how to obtain the binary stopping criterion from\nthe white matter mask defined above. The binary stopping criterion uses a\nnearest-neighborhood interpolation at the tracking position.</p>\n<p><strong>Parameters</strong></p>\n<ul class=\"simple\">\n<li><p>mask: numpy array [:, :, :]</p></li>\n</ul>\n<p><strong>Stopping States</strong></p>\n<ul class=\"simple\">\n<li><p>\u2018ENDPOINT\u2019: stops at a position where mask = 0; the streamline</p></li>\n</ul>\n<p>reached the target stopping area.\n- \u2018OUTSIDEIMAGE\u2019: stops at a position outside of metric_map; the streamline\nreached an area outside the image where no direction data is available.\n- \u2018TRACKPOINT\u2019: stops at a position because no direction is available; the\nstreamline is stopping where mask &gt; 0, but there is no valid direction to\nfollow.\n- \u2018INVALIDPOINT\u2019: N/A.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">binary_criterion</span> <span class=\"o\">=</span> <span class=\"n\">BinaryStoppingCriterion</span><span class=\"p\">(</span><span class=\"n\">white_matter</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">()</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">xticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">yticks</span><span class=\"p\">([])</span>\n<span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">tight_layout</span><span class=\"p\">()</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">white_matter</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"o\">//</span> <span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span>\n           <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;white_matter_mask.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_003.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_003.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id7\">\n<img alt=\"examples_built/13_fiber_tracking/white_matter_mask.png\" src=\"examples_built/13_fiber_tracking/white_matter_mask.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>White matter binary mask.</strong></span><a class=\"headerlink\" href=\"#id7\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                     <span class=\"n\">binary_criterion</span><span class=\"p\">,</span>\n                                     <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                     <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">,</span>\n                                     <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_deterministic_binary_all.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_deterministic_binary_all.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_004.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_004.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id8\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_deterministic_binary_all.png\" src=\"examples_built/13_fiber_tracking/tractogram_deterministic_binary_all.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using deterministic tractography with a binary white\nmatter mask.</strong></span><a class=\"headerlink\" href=\"#id8\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n</section>\n<section id=\"act-stopping-criterion\">\n<h2>ACT Stopping Criterion<a class=\"headerlink\" href=\"#act-stopping-criterion\" title=\"Permalink to this heading\">\u00b6</a></h2>\n<p>Anatomically-constrained tractography (ACT) <a class=\"reference internal\" href=\"#smith2012\" id=\"id3\"><span>[Smith2012]</span></a> uses information from\nanatomical images to determine when the tractography stops. The <code class=\"docutils literal notranslate\"><span class=\"pre\">include_map</span></code>\ndefines when the streamline reached a \u2018valid\u2019 stopping region (e.g. gray\nmatter partial volume estimation (PVE) map) and the <code class=\"docutils literal notranslate\"><span class=\"pre\">exclude_map</span></code> defines\nwhen the streamline reached an \u2018invalid\u2019 stopping region (e.g. corticospinal\nfluid PVE map). The background of the anatomical image should be added to the\n<code class=\"docutils literal notranslate\"><span class=\"pre\">include_map</span></code> to keep streamlines exiting the brain (e.g. through the\nbrain stem). The ACT stopping criterion uses a trilinear interpolation\nat the tracking position.</p>\n<p><strong>Parameters</strong></p>\n<ul class=\"simple\">\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">include_map</span></code>: numpy array <code class=\"docutils literal notranslate\"><span class=\"pre\">[:,</span> <span class=\"pre\">:,</span> <span class=\"pre\">:]</span></code>,</p></li>\n<li><p><code class=\"docutils literal notranslate\"><span class=\"pre\">exclude_map</span></code>: numpy array <code class=\"docutils literal notranslate\"><span class=\"pre\">[:,</span> <span class=\"pre\">:,</span> <span class=\"pre\">:]</span></code>,</p></li>\n</ul>\n<p><strong>Stopping States</strong></p>\n<ul class=\"simple\">\n<li><p>\u2018ENDPOINT\u2019: stops at a position where <code class=\"docutils literal notranslate\"><span class=\"pre\">include_map</span></code> &gt; 0.5; the streamline</p></li>\n</ul>\n<p>reached the target stopping area.\n- \u2018OUTSIDEIMAGE\u2019: stops at a position outside of <code class=\"docutils literal notranslate\"><span class=\"pre\">include_map</span></code> or\n<code class=\"docutils literal notranslate\"><span class=\"pre\">exclude_map</span></code>; the streamline reached an area outside the image where no\ndirection data is available.\n- \u2018TRACKPOINT\u2019: stops at a position because no direction is available; the\nstreamline is stopping where <code class=\"docutils literal notranslate\"><span class=\"pre\">include_map</span></code> &lt; 0.5 and <code class=\"docutils literal notranslate\"><span class=\"pre\">exclude_map</span></code> &lt; 0.5,\nbut there is no valid direction to follow.\n- \u2018INVALIDPOINT\u2019: <code class=\"docutils literal notranslate\"><span class=\"pre\">exclude_map</span></code> &gt; 0.5; the streamline reach a position which\nis anatomically not plausible.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">f_pve_csf</span><span class=\"p\">,</span> <span class=\"n\">f_pve_gm</span><span class=\"p\">,</span> <span class=\"n\">f_pve_wm</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_pve_maps&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">pve_csf_data</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">f_pve_csf</span><span class=\"p\">)</span>\n<span class=\"n\">pve_gm_data</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">f_pve_gm</span><span class=\"p\">)</span>\n<span class=\"n\">pve_wm_data</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">f_pve_wm</span><span class=\"p\">)</span>\n\n<span class=\"n\">background</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ones</span><span class=\"p\">(</span><span class=\"n\">pve_gm_data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">)</span>\n<span class=\"n\">background</span><span class=\"p\">[(</span><span class=\"n\">pve_gm_data</span> <span class=\"o\">+</span> <span class=\"n\">pve_wm_data</span> <span class=\"o\">+</span> <span class=\"n\">pve_csf_data</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n\n<span class=\"n\">include_map</span> <span class=\"o\">=</span> <span class=\"n\">pve_gm_data</span>\n<span class=\"n\">include_map</span><span class=\"p\">[</span><span class=\"n\">background</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n<span class=\"n\">exclude_map</span> <span class=\"o\">=</span> <span class=\"n\">pve_csf_data</span>\n\n<span class=\"n\">act_criterion</span> <span class=\"o\">=</span> <span class=\"n\">ActStoppingCriterion</span><span class=\"p\">(</span><span class=\"n\">include_map</span><span class=\"p\">,</span> <span class=\"n\">exclude_map</span><span class=\"p\">)</span>\n\n<span class=\"n\">fig</span> <span class=\"o\">=</span> <span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">figure</span><span class=\"p\">()</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">subplot</span><span class=\"p\">(</span><span class=\"mi\">121</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">xticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">yticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">include_map</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"o\">//</span> <span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span>\n           <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">subplot</span><span class=\"p\">(</span><span class=\"mi\">122</span><span class=\"p\">)</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">xticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">yticks</span><span class=\"p\">([])</span>\n<span class=\"n\">plt</span><span class=\"o\">.</span><span class=\"n\">imshow</span><span class=\"p\">(</span><span class=\"n\">exclude_map</span><span class=\"p\">[:,</span> <span class=\"p\">:,</span> <span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">shape</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span> <span class=\"o\">//</span> <span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">T</span><span class=\"p\">,</span> <span class=\"n\">cmap</span><span class=\"o\">=</span><span class=\"s1\">&#39;gray&#39;</span><span class=\"p\">,</span>\n           <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"s1\">&#39;lower&#39;</span><span class=\"p\">,</span> <span class=\"n\">interpolation</span><span class=\"o\">=</span><span class=\"s1\">&#39;nearest&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">tight_layout</span><span class=\"p\">()</span>\n<span class=\"n\">fig</span><span class=\"o\">.</span><span class=\"n\">savefig</span><span class=\"p\">(</span><span class=\"s1\">&#39;act_maps.png&#39;</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_005.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_005.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id9\">\n<img alt=\"examples_built/13_fiber_tracking/act_maps.png\" src=\"examples_built/13_fiber_tracking/act_maps.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Include (left) and exclude (right) maps for ACT.</strong></span><a class=\"headerlink\" href=\"#id9\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                     <span class=\"n\">act_criterion</span><span class=\"p\">,</span>\n                                     <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                     <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">,</span>\n                                     <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_deterministic_act_all.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_deterministic_act_all.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_006.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_006.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id10\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_deterministic_act_all.png\" src=\"examples_built/13_fiber_tracking/tractogram_deterministic_act_all.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using deterministic tractography with ACT stopping\ncriterion.</strong></span><a class=\"headerlink\" href=\"#id10\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">dg</span><span class=\"p\">,</span>\n                                     <span class=\"n\">act_criterion</span><span class=\"p\">,</span>\n                                     <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span>\n                                     <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">,</span>\n                                     <span class=\"n\">return_all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_deterministic_act_valid.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_deterministic_act_valid.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_stopping_criterion_007.png\" srcset=\"../../_images/sphx_glr_tracking_stopping_criterion_007.png\" alt=\"tracking stopping criterion\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id11\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_deterministic_act_valid.png\" src=\"examples_built/13_fiber_tracking/tractogram_deterministic_act_valid.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using deterministic tractography with ACT stopping\ncriterion. Streamlines ending in gray matter region only.</strong></span><a class=\"headerlink\" href=\"#id11\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p>The threshold and binary stopping criterion use respectively a scalar map and a\nbinary mask to stop the tracking. The ACT stopping criterion use partial volume\nfraction (PVE) maps from an anatomical image to stop the tracking.\nAdditionally, the ACT stopping criterion determines if the tracking stopped in\nexpected regions (e.g. gray matter) and allows the user to get only\nstreamlines stopping in those regions.</p>\n<section id=\"notes\">\n<h3>Notes<a class=\"headerlink\" href=\"#notes\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<p>Currently,the proposed method that cuts streamlines going through\nsubcortical gray matter regions is not implemented. The\nbacktracking technique for streamlines reaching INVALIDPOINT is not\nimplemented either <a class=\"reference internal\" href=\"#smith2012\" id=\"id4\"><span>[Smith2012]</span></a>.</p>\n</section>\n<section id=\"references\">\n<h3>References<a class=\"headerlink\" href=\"#references\" title=\"Permalink to this heading\">\u00b6</a></h3>\n<div role=\"list\" class=\"citation-list\">\n<div class=\"citation\" id=\"smith2012\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span>Smith2012<span class=\"fn-bracket\">]</span></span>\n<span class=\"backrefs\">(<a role=\"doc-backlink\" href=\"#id2\">1</a>,<a role=\"doc-backlink\" href=\"#id3\">2</a>,<a role=\"doc-backlink\" href=\"#id4\">3</a>)</span>\n<p>Smith, R. E., Tournier, J.-D., Calamante, F., &amp; Connelly, A.\nAnatomically-constrained tractography: Improved diffusion MRI\nstreamlines tractography through effective use of anatomical\ninformation. NeuroImage, 63(3), 1924-1938, 2012.</p>\n</div>\n<div class=\"citation\" id=\"girard2014\" role=\"doc-biblioentry\">\n<span class=\"label\"><span class=\"fn-bracket\">[</span><a role=\"doc-backlink\" href=\"#id1\">Girard2014</a><span class=\"fn-bracket\">]</span></span>\n<p>Girard, G., Whittingstall, K., Deriche, R., &amp; Descoteaux, M.\nTowards quantitative connectivity analysis: reducing tractography biases.\nNeuroImage, 98, 266-278, 2014.</p>\n</div>\n</div>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 1 minutes  8.901 seconds)</p>\n<div class=\"sphx-glr-footer sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-13-fiber-tracking-tracking-stopping-criterion-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/6dfef0be3fe801895dc685e9adf44173/tracking_stopping_criterion.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">tracking_stopping_criterion.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/96b1afc98f38936d7537f8b9ea300bfa/tracking_stopping_criterion.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">tracking_stopping_criterion.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</section>\n</section>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["examples_built/17_streamline_analysis/index", "Streamlines Analysis and Connectivity", "N", "next"], ["examples_built/13_fiber_tracking/linear_fascicle_evaluation", "Linear fascicle evaluation (LiFE)", "P", "previous"]], "sourcename": "examples_built/13_fiber_tracking/tracking_stopping_criterion.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Using Various Stopping Criterion for Tractography</a><ul>\n<li><a class=\"reference internal\" href=\"#threshold-stopping-criterion\">Threshold Stopping Criterion</a></li>\n<li><a class=\"reference internal\" href=\"#binary-stopping-criterion\">Binary Stopping Criterion</a></li>\n<li><a class=\"reference internal\" href=\"#act-stopping-criterion\">ACT Stopping Criterion</a><ul>\n<li><a class=\"reference internal\" href=\"#notes\">Notes</a></li>\n<li><a class=\"reference internal\" href=\"#references\">References</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "examples_built/13_fiber_tracking/tracking_stopping_criterion", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}