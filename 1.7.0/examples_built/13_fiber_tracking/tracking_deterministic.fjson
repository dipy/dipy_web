{"parents": [{"link": "../../../documentation/", "title": "Documentation"}, {"link": "../../", "title": "Examples"}, {"link": "../", "title": "Fiber Tracking"}], "prev": {"link": "../surface_seed/", "title": "Surface seeding for tractography"}, "next": {"link": "../tracking_ptt/", "title": "Parallel Transport Tractography"}, "title": "An introduction to the Deterministic Maximum Direction Getter", "meta": null, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-13-fiber-tracking-tracking-deterministic-py\"><span class=\"std std-ref\">here</span></a>\nto download the full example code</p>\n</div>\n<section class=\"sphx-glr-example-title\" id=\"an-introduction-to-the-deterministic-maximum-direction-getter\">\n<span id=\"sphx-glr-examples-built-13-fiber-tracking-tracking-deterministic-py\"></span><h1>An introduction to the Deterministic Maximum Direction Getter<a class=\"headerlink\" href=\"#an-introduction-to-the-deterministic-maximum-direction-getter\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>Deterministic maximum direction getter is the deterministic version of the\nprobabilistic direction getter. It can be used with the same local models\nand has the same parameters. Deterministic maximum fiber tracking follows\nthe trajectory of the most probable pathway within the tracking constraint\n(e.g. max angle). In other words, it follows the direction with the highest\nprobability from a distribution, as opposed to the probabilistic direction\ngetter which draws the direction from the distribution. Therefore, the maximum\ndeterministic direction getter is equivalent to the probabilistic direction\ngetter returning always the maximum value of the distribution.</p>\n<p>Deterministic maximum fiber tracking is an alternative to EuDX deterministic\ntractography and unlike EuDX does not follow the peaks of the local models but\nuses the entire orientation distributions.</p>\n<p>This example is an extension of the <span class=\"xref std std-ref\">example_tracking_probabilistic</span>\nexample. We begin by loading the data, fitting a Constrained Spherical\nDeconvolution (CSD) reconstruction model for the tractography and fitting\nthe constant solid angle (CSA) reconstruction model to define the tracking\nmask (stopping criterion).</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">gradient_table</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">default_sphere</span><span class=\"p\">,</span> <span class=\"n\">get_fnames</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">DeterministicMaximumDirectionGetter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">read_bvals_bvecs</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.image</span> <span class=\"kn\">import</span> <span class=\"n\">load_nifti</span><span class=\"p\">,</span> <span class=\"n\">load_nifti_data</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.stateful_tractogram</span> <span class=\"kn\">import</span> <span class=\"n\">Space</span><span class=\"p\">,</span> <span class=\"n\">StatefulTractogram</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">save_trk</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">,</span>\n                                   <span class=\"n\">auto_response_ssst</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.shm</span> <span class=\"kn\">import</span> <span class=\"n\">CsaOdfModel</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking</span> <span class=\"kn\">import</span> <span class=\"n\">utils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local_tracking</span> <span class=\"kn\">import</span> <span class=\"n\">LocalTracking</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.stopping_criterion</span> <span class=\"kn\">import</span> <span class=\"n\">ThresholdStoppingCriterion</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">Streamlines</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"kn\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"p\">,</span> <span class=\"n\">has_fury</span>\n\n<span class=\"c1\"># Enables/disables interactive visualization</span>\n<span class=\"n\">interactive</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n\n<span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_hardi&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">label_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_labels&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">return_img</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">label_fname</span><span class=\"p\">)</span>\n<span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span> <span class=\"o\">=</span> <span class=\"n\">read_bvals_bvecs</span><span class=\"p\">(</span><span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span><span class=\"p\">)</span>\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span><span class=\"p\">)</span>\n\n<span class=\"n\">seed_mask</span> <span class=\"o\">=</span> <span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span>\n<span class=\"n\">white_matter</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">|</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">seeds</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">seeds_from_mask</span><span class=\"p\">(</span><span class=\"n\">seed_mask</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">density</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">ratio</span> <span class=\"o\">=</span> <span class=\"n\">auto_response_ssst</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">roi_radii</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">fa_thr</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n\n<span class=\"n\">csd_model</span> <span class=\"o\">=</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">sh_order</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit</span> <span class=\"o\">=</span> <span class=\"n\">csd_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">white_matter</span><span class=\"p\">)</span>\n\n<span class=\"n\">csa_model</span> <span class=\"o\">=</span> <span class=\"n\">CsaOdfModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">sh_order</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">)</span>\n<span class=\"n\">gfa</span> <span class=\"o\">=</span> <span class=\"n\">csa_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">white_matter</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">gfa</span>\n<span class=\"n\">stopping_criterion</span> <span class=\"o\">=</span> <span class=\"n\">ThresholdStoppingCriterion</span><span class=\"p\">(</span><span class=\"n\">gfa</span><span class=\"p\">,</span> <span class=\"mf\">.25</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>  0%|          | 0/58788 [00:00&lt;?, ?it/s]\n  1%|1         | 697/58788 [00:00&lt;00:08, 6963.38it/s]\n  3%|2         | 1591/58788 [00:00&lt;00:07, 8094.80it/s]\n  4%|4         | 2510/58788 [00:00&lt;00:06, 8592.90it/s]\n  6%|5         | 3389/58788 [00:00&lt;00:06, 8669.02it/s]\n  7%|7         | 4277/58788 [00:00&lt;00:06, 8738.89it/s]\n  9%|8         | 5162/58788 [00:00&lt;00:06, 8774.84it/s]\n 10%|#         | 6108/58788 [00:00&lt;00:05, 8997.57it/s]\n 12%|#2        | 7058/58788 [00:00&lt;00:05, 9156.74it/s]\n 14%|#3        | 8020/58788 [00:00&lt;00:05, 9300.11it/s]\n 15%|#5        | 8964/58788 [00:01&lt;00:05, 9342.42it/s]\n 17%|#6        | 9926/58788 [00:01&lt;00:05, 9427.14it/s]\n 19%|#8        | 10895/58788 [00:01&lt;00:05, 9505.37it/s]\n 20%|##        | 11846/58788 [00:01&lt;00:05, 9354.26it/s]\n 22%|##1       | 12782/58788 [00:01&lt;00:04, 9291.52it/s]\n 23%|##3       | 13712/58788 [00:01&lt;00:04, 9287.30it/s]\n 25%|##4       | 14642/58788 [00:01&lt;00:04, 9249.31it/s]\n 26%|##6       | 15568/58788 [00:01&lt;00:04, 9206.28it/s]\n 28%|##8       | 16534/58788 [00:01&lt;00:04, 9340.75it/s]\n 30%|##9       | 17490/58788 [00:01&lt;00:04, 9405.83it/s]\n 31%|###1      | 18436/58788 [00:02&lt;00:04, 9419.98it/s]\n 33%|###2      | 19390/58788 [00:02&lt;00:04, 9455.33it/s]\n 35%|###4      | 20336/58788 [00:02&lt;00:04, 9393.55it/s]\n 36%|###6      | 21276/58788 [00:02&lt;00:04, 9360.07it/s]\n 38%|###7      | 22236/58788 [00:02&lt;00:03, 9430.80it/s]\n 39%|###9      | 23189/58788 [00:02&lt;00:03, 9456.86it/s]\n 41%|####1     | 24153/58788 [00:02&lt;00:03, 9509.35it/s]\n 43%|####2     | 25123/58788 [00:02&lt;00:03, 9566.02it/s]\n 44%|####4     | 26080/58788 [00:02&lt;00:03, 9537.54it/s]\n 46%|####5     | 27034/58788 [00:02&lt;00:03, 9483.68it/s]\n 48%|####7     | 27983/58788 [00:03&lt;00:03, 9449.15it/s]\n 49%|####9     | 28928/58788 [00:03&lt;00:03, 9382.20it/s]\n 51%|#####     | 29867/58788 [00:03&lt;00:03, 9273.31it/s]\n 52%|#####2    | 30795/58788 [00:03&lt;00:03, 9163.49it/s]\n 54%|#####3    | 31712/58788 [00:03&lt;00:02, 9067.07it/s]\n 55%|#####5    | 32619/58788 [00:03&lt;00:02, 9035.14it/s]\n 57%|#####7    | 33539/58788 [00:03&lt;00:02, 9081.63it/s]\n 59%|#####8    | 34448/58788 [00:03&lt;00:02, 9036.69it/s]\n 60%|######    | 35394/58788 [00:03&lt;00:02, 9161.20it/s]\n 62%|######1   | 36352/58788 [00:03&lt;00:02, 9282.82it/s]\n 63%|######3   | 37316/58788 [00:04&lt;00:02, 9389.12it/s]\n 65%|######5   | 38268/58788 [00:04&lt;00:02, 9427.54it/s]\n 67%|######6   | 39248/58788 [00:04&lt;00:02, 9537.20it/s]\n 68%|######8   | 40204/58788 [00:04&lt;00:01, 9543.86it/s]\n 70%|#######   | 41159/58788 [00:04&lt;00:01, 9543.84it/s]\n 72%|#######1  | 42133/58788 [00:04&lt;00:01, 9600.98it/s]\n 73%|#######3  | 43094/58788 [00:04&lt;00:01, 9563.46it/s]\n 75%|#######4  | 44053/58788 [00:04&lt;00:01, 9568.79it/s]\n 77%|#######6  | 45010/58788 [00:04&lt;00:01, 9554.89it/s]\n 78%|#######8  | 45966/58788 [00:04&lt;00:01, 9503.66it/s]\n 80%|#######9  | 46931/58788 [00:05&lt;00:01, 9545.33it/s]\n 81%|########1 | 47898/58788 [00:05&lt;00:01, 9581.52it/s]\n 83%|########3 | 48857/58788 [00:05&lt;00:01, 9540.02it/s]\n 85%|########4 | 49823/58788 [00:05&lt;00:00, 9574.91it/s]\n 86%|########6 | 50801/58788 [00:05&lt;00:00, 9636.03it/s]\n 88%|########8 | 51765/58788 [00:05&lt;00:00, 9552.28it/s]\n 90%|########9 | 52721/58788 [00:05&lt;00:00, 9471.09it/s]\n 91%|#########1| 53669/58788 [00:05&lt;00:00, 9433.02it/s]\n 93%|#########2| 54613/58788 [00:05&lt;00:00, 9322.32it/s]\n 95%|#########4| 55560/58788 [00:05&lt;00:00, 9365.25it/s]\n 96%|#########6| 56497/58788 [00:06&lt;00:00, 9272.91it/s]\n 98%|#########7| 57425/58788 [00:06&lt;00:00, 9220.19it/s]\n 99%|#########9| 58348/58788 [00:06&lt;00:00, 9098.55it/s]\n100%|##########| 58788/58788 [00:06&lt;00:00, 9280.43it/s]\n</pre></div>\n</div>\n<p>The Fiber Orientation Distribution (FOD) of the CSD model estimates the\ndistribution of small fiber bundles within each voxel. This distribution\ncan be used for deterministic fiber tracking. As for probabilistic tracking,\nthere are many ways to provide those distributions to the deterministic maximum\ndirection getter. Here, the spherical harmonic representation of the FOD\nis used.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"n\">detmax_dg</span> <span class=\"o\">=</span> <span class=\"n\">DeterministicMaximumDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span>\n    <span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span><span class=\"p\">,</span> <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">30.</span><span class=\"p\">,</span> <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n<span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">detmax_dg</span><span class=\"p\">,</span> <span class=\"n\">stopping_criterion</span><span class=\"p\">,</span> <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_deterministic_dg.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_deterministic_dg.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_deterministic_001.png\" srcset=\"../../_images/sphx_glr_tracking_deterministic_001.png\" alt=\"tracking deterministic\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id1\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_deterministic_dg.png\" src=\"examples_built/13_fiber_tracking/tractogram_deterministic_dg.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using deterministic maximum direction getter</strong></span><a class=\"headerlink\" href=\"#id1\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 0 minutes  13.862 seconds)</p>\n<div class=\"sphx-glr-footer sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-13-fiber-tracking-tracking-deterministic-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/1f1378fca836a6befb5559fae4d9d615/tracking_deterministic.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">tracking_deterministic.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/78035755b0ef0a0a1956193a0391ee4e/tracking_deterministic.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">tracking_deterministic.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["examples_built/13_fiber_tracking/tracking_ptt", "Parallel Transport Tractography", "N", "next"], ["examples_built/13_fiber_tracking/surface_seed", "Surface seeding for tractography", "P", "previous"]], "sourcename": "examples_built/13_fiber_tracking/tracking_deterministic.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">An introduction to the Deterministic Maximum Direction Getter</a></li>\n</ul>\n", "display_toc": false, "page_source_suffix": ".rst", "current_page_name": "examples_built/13_fiber_tracking/tracking_deterministic", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}