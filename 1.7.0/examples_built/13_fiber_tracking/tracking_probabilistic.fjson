{"parents": [{"link": "../../../documentation/", "title": "Documentation"}, {"link": "../../", "title": "Examples"}, {"link": "../", "title": "Fiber Tracking"}], "prev": {"link": "../tracking_introduction_eudx_1/", "title": "Introduction to Basic Tracking"}, "next": {"link": "../tracking_pft/", "title": "Particle Filtering Tractography"}, "title": "An introduction to the Probabilistic Direction Getter", "meta": null, "body": "<div class=\"sphx-glr-download-link-note admonition note\">\n<p class=\"admonition-title\">Note</p>\n<p>Click <a class=\"reference internal\" href=\"#sphx-glr-download-examples-built-13-fiber-tracking-tracking-probabilistic-py\"><span class=\"std std-ref\">here</span></a>\nto download the full example code</p>\n</div>\n<section class=\"sphx-glr-example-title\" id=\"an-introduction-to-the-probabilistic-direction-getter\">\n<span id=\"sphx-glr-examples-built-13-fiber-tracking-tracking-probabilistic-py\"></span><h1>An introduction to the Probabilistic Direction Getter<a class=\"headerlink\" href=\"#an-introduction-to-the-probabilistic-direction-getter\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>Probabilistic fiber tracking is a way of reconstructing white matter\nconnections using diffusion MR imaging. Like deterministic fiber tracking, the\nprobabilistic approach follows the trajectory of a possible pathway step by\nstep starting at a seed, however, unlike deterministic tracking, the tracking\ndirection at each point along the path is chosen at random from a distribution.\nThe distribution at each point is different and depends on the observed\ndiffusion data at that point. The distribution of tracking directions at each\npoint can be represented as a probability mass function (PMF) if the possible\ntracking directions are restricted to discrete numbers of well distributed\npoints on a sphere.</p>\n<p>This example is an extension of the <span class=\"xref std std-ref\">example_tracking_introduction_eudx</span>\nexample. We\u2019ll begin by repeating a few steps from that example, loading the\ndata and fitting a Constrained Spherical Deconvolution (CSD) model.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.core.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">gradient_table</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">get_fnames</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.gradients</span> <span class=\"kn\">import</span> <span class=\"n\">read_bvals_bvecs</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.image</span> <span class=\"kn\">import</span> <span class=\"n\">load_nifti</span><span class=\"p\">,</span> <span class=\"n\">load_nifti_data</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.csdeconv</span> <span class=\"kn\">import</span> <span class=\"p\">(</span><span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">,</span>\n                                   <span class=\"n\">auto_response_ssst</span><span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking</span> <span class=\"kn\">import</span> <span class=\"n\">utils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.local_tracking</span> <span class=\"kn\">import</span> <span class=\"n\">LocalTracking</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">Streamlines</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.tracking.stopping_criterion</span> <span class=\"kn\">import</span> <span class=\"n\">ThresholdStoppingCriterion</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.viz</span> <span class=\"kn\">import</span> <span class=\"n\">window</span><span class=\"p\">,</span> <span class=\"n\">actor</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"p\">,</span> <span class=\"n\">has_fury</span>\n\n\n<span class=\"c1\"># Enables/disables interactive visualization</span>\n<span class=\"n\">interactive</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n<span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_hardi&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">label_fname</span> <span class=\"o\">=</span> <span class=\"n\">get_fnames</span><span class=\"p\">(</span><span class=\"s1\">&#39;stanford_labels&#39;</span><span class=\"p\">)</span>\n\n<span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti</span><span class=\"p\">(</span><span class=\"n\">hardi_fname</span><span class=\"p\">,</span> <span class=\"n\">return_img</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n<span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"n\">load_nifti_data</span><span class=\"p\">(</span><span class=\"n\">label_fname</span><span class=\"p\">)</span>\n<span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span> <span class=\"o\">=</span> <span class=\"n\">read_bvals_bvecs</span><span class=\"p\">(</span><span class=\"n\">hardi_bval_fname</span><span class=\"p\">,</span> <span class=\"n\">hardi_bvec_fname</span><span class=\"p\">)</span>\n<span class=\"n\">gtab</span> <span class=\"o\">=</span> <span class=\"n\">gradient_table</span><span class=\"p\">(</span><span class=\"n\">bvals</span><span class=\"p\">,</span> <span class=\"n\">bvecs</span><span class=\"p\">)</span>\n\n<span class=\"n\">seed_mask</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">white_matter</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"o\">|</span> <span class=\"p\">(</span><span class=\"n\">labels</span> <span class=\"o\">==</span> <span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">seeds</span> <span class=\"o\">=</span> <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">seeds_from_mask</span><span class=\"p\">(</span><span class=\"n\">seed_mask</span><span class=\"p\">,</span> <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">density</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">ratio</span> <span class=\"o\">=</span> <span class=\"n\">auto_response_ssst</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">roi_radii</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">fa_thr</span><span class=\"o\">=</span><span class=\"mf\">0.7</span><span class=\"p\">)</span>\n<span class=\"n\">csd_model</span> <span class=\"o\">=</span> <span class=\"n\">ConstrainedSphericalDeconvModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">sh_order</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">)</span>\n<span class=\"n\">csd_fit</span> <span class=\"o\">=</span> <span class=\"n\">csd_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">white_matter</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<div class=\"sphx-glr-script-out highlight-none notranslate\"><div class=\"highlight\"><pre><span></span>  0%|          | 0/58788 [00:00&lt;?, ?it/s]\n  1%|1         | 649/58788 [00:00&lt;00:08, 6485.07it/s]\n  3%|2         | 1510/58788 [00:00&lt;00:07, 7733.68it/s]\n  4%|4         | 2389/58788 [00:00&lt;00:06, 8213.36it/s]\n  6%|5         | 3273/58788 [00:00&lt;00:06, 8459.50it/s]\n  7%|7         | 4163/58788 [00:00&lt;00:06, 8617.80it/s]\n  9%|8         | 5070/58788 [00:00&lt;00:06, 8770.15it/s]\n 10%|#         | 5978/58788 [00:00&lt;00:05, 8869.44it/s]\n 12%|#1        | 6880/58788 [00:00&lt;00:05, 8917.01it/s]\n 13%|#3        | 7775/58788 [00:00&lt;00:05, 8926.85it/s]\n 15%|#4        | 8687/58788 [00:01&lt;00:05, 8983.09it/s]\n 16%|#6        | 9617/58788 [00:01&lt;00:05, 9077.68it/s]\n 18%|#7        | 10537/58788 [00:01&lt;00:05, 9114.01it/s]\n 19%|#9        | 11449/58788 [00:01&lt;00:05, 9081.69it/s]\n 21%|##1       | 12364/58788 [00:01&lt;00:05, 9100.48it/s]\n 23%|##2       | 13300/58788 [00:01&lt;00:04, 9176.25it/s]\n 24%|##4       | 14218/58788 [00:01&lt;00:04, 9157.63it/s]\n 26%|##5       | 15139/58788 [00:01&lt;00:04, 9173.00it/s]\n 27%|##7       | 16075/58788 [00:01&lt;00:04, 9228.84it/s]\n 29%|##8       | 16998/58788 [00:01&lt;00:04, 9203.98it/s]\n 31%|###       | 17944/58788 [00:02&lt;00:04, 9278.66it/s]\n 32%|###2      | 18872/58788 [00:02&lt;00:04, 9210.64it/s]\n 34%|###3      | 19794/58788 [00:02&lt;00:04, 9082.08it/s]\n 35%|###5      | 20717/58788 [00:02&lt;00:04, 9124.61it/s]\n 37%|###6      | 21630/58788 [00:02&lt;00:04, 9085.82it/s]\n 38%|###8      | 22553/58788 [00:02&lt;00:03, 9128.60it/s]\n 40%|###9      | 23467/58788 [00:02&lt;00:03, 9111.50it/s]\n 41%|####1     | 24387/58788 [00:02&lt;00:03, 9136.70it/s]\n 43%|####3     | 25312/58788 [00:02&lt;00:03, 9169.12it/s]\n 45%|####4     | 26230/58788 [00:02&lt;00:03, 9059.11it/s]\n 46%|####6     | 27137/58788 [00:03&lt;00:03, 8994.00it/s]\n 48%|####7     | 28037/58788 [00:03&lt;00:03, 8931.31it/s]\n 49%|####9     | 28931/58788 [00:03&lt;00:03, 8841.57it/s]\n 51%|#####     | 29816/58788 [00:03&lt;00:03, 8746.33it/s]\n 52%|#####2    | 30692/58788 [00:03&lt;00:03, 8749.86it/s]\n 54%|#####3    | 31568/58788 [00:03&lt;00:03, 8729.90it/s]\n 55%|#####5    | 32449/58788 [00:03&lt;00:03, 8750.33it/s]\n 57%|#####6    | 33363/58788 [00:03&lt;00:02, 8863.82it/s]\n 58%|#####8    | 34267/58788 [00:03&lt;00:02, 8915.53it/s]\n 60%|#####9    | 35165/58788 [00:03&lt;00:02, 8934.60it/s]\n 61%|######1   | 36093/58788 [00:04&lt;00:02, 9035.47it/s]\n 63%|######2   | 36999/58788 [00:04&lt;00:02, 9042.44it/s]\n 65%|######4   | 37930/58788 [00:04&lt;00:02, 9119.95it/s]\n 66%|######6   | 38858/58788 [00:04&lt;00:02, 9167.38it/s]\n 68%|######7   | 39775/58788 [00:04&lt;00:02, 9154.91it/s]\n 69%|######9   | 40711/58788 [00:04&lt;00:01, 9215.62it/s]\n 71%|#######   | 41638/58788 [00:04&lt;00:01, 9229.12it/s]\n 72%|#######2  | 42572/58788 [00:04&lt;00:01, 9259.70it/s]\n 74%|#######3  | 43498/58788 [00:04&lt;00:01, 9252.64it/s]\n 76%|#######5  | 44424/58788 [00:04&lt;00:01, 9174.68it/s]\n 77%|#######7  | 45360/58788 [00:05&lt;00:01, 9227.96it/s]\n 79%|#######8  | 46283/58788 [00:05&lt;00:01, 9228.07it/s]\n 80%|########  | 47206/58788 [00:05&lt;00:01, 9201.09it/s]\n 82%|########1 | 48140/58788 [00:05&lt;00:01, 9240.65it/s]\n 83%|########3 | 49072/58788 [00:05&lt;00:01, 9262.07it/s]\n 85%|########5 | 50001/58788 [00:05&lt;00:00, 9270.01it/s]\n 87%|########6 | 50929/58788 [00:05&lt;00:00, 9265.57it/s]\n 88%|########8 | 51856/58788 [00:05&lt;00:00, 9219.25it/s]\n 90%|########9 | 52778/58788 [00:05&lt;00:00, 9178.67it/s]\n 91%|#########1| 53696/58788 [00:05&lt;00:00, 9143.74it/s]\n 93%|#########2| 54611/58788 [00:06&lt;00:00, 9143.89it/s]\n 94%|#########4| 55528/58788 [00:06&lt;00:00, 9150.91it/s]\n 96%|#########6| 56444/58788 [00:06&lt;00:00, 9043.12it/s]\n 98%|#########7| 57349/58788 [00:06&lt;00:00, 9005.38it/s]\n 99%|#########9| 58250/58788 [00:06&lt;00:00, 8802.61it/s]\n100%|##########| 58788/58788 [00:06&lt;00:00, 8992.19it/s]\n</pre></div>\n</div>\n<p>We use the GFA of the CSA model to build a stopping criterion.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.reconst.shm</span> <span class=\"kn\">import</span> <span class=\"n\">CsaOdfModel</span>\n\n<span class=\"n\">csa_model</span> <span class=\"o\">=</span> <span class=\"n\">CsaOdfModel</span><span class=\"p\">(</span><span class=\"n\">gtab</span><span class=\"p\">,</span> <span class=\"n\">sh_order</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">)</span>\n<span class=\"n\">gfa</span> <span class=\"o\">=</span> <span class=\"n\">csa_model</span><span class=\"o\">.</span><span class=\"n\">fit</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">white_matter</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">gfa</span>\n<span class=\"n\">stopping_criterion</span> <span class=\"o\">=</span> <span class=\"n\">ThresholdStoppingCriterion</span><span class=\"p\">(</span><span class=\"n\">gfa</span><span class=\"p\">,</span> <span class=\"mf\">.25</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<p>The Fiber Orientation Distribution (FOD) of the CSD model estimates the\ndistribution of small fiber bundles within each voxel. We can use this\ndistribution for probabilistic fiber tracking. One way to do this is to\nrepresent the FOD using a discrete sphere. This discrete FOD can be used by the\n<code class=\"docutils literal notranslate\"><span class=\"pre\">ProbabilisticDirectionGetter</span></code> as a PMF for sampling tracking directions. We\nneed to clip the FOD to use it as a PMF because the latter cannot have negative\nvalues. Ideally, the FOD should be strictly positive, but because of noise\nand/or model failures sometimes it can have negative values.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">ProbabilisticDirectionGetter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">small_sphere</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.stateful_tractogram</span> <span class=\"kn\">import</span> <span class=\"n\">Space</span><span class=\"p\">,</span> <span class=\"n\">StatefulTractogram</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dipy.io.streamline</span> <span class=\"kn\">import</span> <span class=\"n\">save_trk</span>\n\n<span class=\"n\">fod</span> <span class=\"o\">=</span> <span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">odf</span><span class=\"p\">(</span><span class=\"n\">small_sphere</span><span class=\"p\">)</span>\n<span class=\"n\">pmf</span> <span class=\"o\">=</span> <span class=\"n\">fod</span><span class=\"o\">.</span><span class=\"n\">clip</span><span class=\"p\">(</span><span class=\"nb\">min</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">prob_dg</span> <span class=\"o\">=</span> <span class=\"n\">ProbabilisticDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_pmf</span><span class=\"p\">(</span><span class=\"n\">pmf</span><span class=\"p\">,</span> <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">30.</span><span class=\"p\">,</span>\n                                                <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">small_sphere</span><span class=\"p\">)</span>\n<span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">prob_dg</span><span class=\"p\">,</span> <span class=\"n\">stopping_criterion</span><span class=\"p\">,</span> <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_probabilistic_dg_pmf.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_probabilistic_dg_pmf.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_probabilistic_001.png\" srcset=\"../../_images/sphx_glr_tracking_probabilistic_001.png\" alt=\"tracking probabilistic\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id1\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_probabilistic_dg_pmf.png\" src=\"examples_built/13_fiber_tracking/tractogram_probabilistic_dg_pmf.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using probabilistic direction getter from PMF</strong></span><a class=\"headerlink\" href=\"#id1\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p>One disadvantage of using a discrete PMF to represent possible tracking\ndirections is that it tends to take up a lot of memory (RAM). The size of the\nPMF, the FOD in this case, must be equal to the number of possible tracking\ndirections on the hemisphere, and every voxel has a unique PMF. In this case\nthe data is <code class=\"docutils literal notranslate\"><span class=\"pre\">(81,</span> <span class=\"pre\">106,</span> <span class=\"pre\">76)</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">small_sphere</span></code> has 181 directions so the\nFOD is <code class=\"docutils literal notranslate\"><span class=\"pre\">(81,</span> <span class=\"pre\">106,</span> <span class=\"pre\">76,</span> <span class=\"pre\">181)</span></code>. One way to avoid sampling the PMF and holding it\nin memory is to build the direction getter directly from the spherical harmonic\n(SH) representation of the FOD. By using this approach, we can also use a\nlarger sphere, like <code class=\"docutils literal notranslate\"><span class=\"pre\">default_sphere</span></code> which has 362 directions on the\nhemisphere, without having to worry about memory limitations.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.data</span> <span class=\"kn\">import</span> <span class=\"n\">default_sphere</span>\n\n<span class=\"n\">prob_dg</span> <span class=\"o\">=</span> <span class=\"n\">ProbabilisticDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span><span class=\"n\">csd_fit</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span><span class=\"p\">,</span>\n                                                    <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">30.</span><span class=\"p\">,</span>\n                                                    <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n<span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">prob_dg</span><span class=\"p\">,</span> <span class=\"n\">stopping_criterion</span><span class=\"p\">,</span> <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_probabilistic_dg_sh.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_probabilistic_dg_sh.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_probabilistic_002.png\" srcset=\"../../_images/sphx_glr_tracking_probabilistic_002.png\" alt=\"tracking probabilistic\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id2\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_probabilistic_dg_sh.png\" src=\"examples_built/13_fiber_tracking/tractogram_probabilistic_dg_sh.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using probabilistic direction getter from SH</strong></span><a class=\"headerlink\" href=\"#id2\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p>Not all model fits have the <code class=\"docutils literal notranslate\"><span class=\"pre\">shm_coeff</span></code> attribute because not all models use\nthis basis to represent the data internally. However we can fit the ODF of any\nmodel to the spherical harmonic basis using the <code class=\"docutils literal notranslate\"><span class=\"pre\">peaks_from_model</span></code> function.</p>\n<div class=\"highlight-default notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"kn\">from</span> <span class=\"nn\">dipy.direction</span> <span class=\"kn\">import</span> <span class=\"n\">peaks_from_model</span>\n\n<span class=\"n\">peaks</span> <span class=\"o\">=</span> <span class=\"n\">peaks_from_model</span><span class=\"p\">(</span><span class=\"n\">csd_model</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">default_sphere</span><span class=\"p\">,</span> <span class=\"mf\">.5</span><span class=\"p\">,</span> <span class=\"mi\">25</span><span class=\"p\">,</span>\n                         <span class=\"n\">mask</span><span class=\"o\">=</span><span class=\"n\">white_matter</span><span class=\"p\">,</span> <span class=\"n\">return_sh</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">parallel</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                         <span class=\"n\">num_processes</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"n\">fod_coeff</span> <span class=\"o\">=</span> <span class=\"n\">peaks</span><span class=\"o\">.</span><span class=\"n\">shm_coeff</span>\n\n<span class=\"n\">prob_dg</span> <span class=\"o\">=</span> <span class=\"n\">ProbabilisticDirectionGetter</span><span class=\"o\">.</span><span class=\"n\">from_shcoeff</span><span class=\"p\">(</span><span class=\"n\">fod_coeff</span><span class=\"p\">,</span> <span class=\"n\">max_angle</span><span class=\"o\">=</span><span class=\"mf\">30.</span><span class=\"p\">,</span>\n                                                    <span class=\"n\">sphere</span><span class=\"o\">=</span><span class=\"n\">default_sphere</span><span class=\"p\">)</span>\n<span class=\"n\">streamline_generator</span> <span class=\"o\">=</span> <span class=\"n\">LocalTracking</span><span class=\"p\">(</span><span class=\"n\">prob_dg</span><span class=\"p\">,</span> <span class=\"n\">stopping_criterion</span><span class=\"p\">,</span> <span class=\"n\">seeds</span><span class=\"p\">,</span>\n                                     <span class=\"n\">affine</span><span class=\"p\">,</span> <span class=\"n\">step_size</span><span class=\"o\">=</span><span class=\"mf\">.5</span><span class=\"p\">)</span>\n<span class=\"n\">streamlines</span> <span class=\"o\">=</span> <span class=\"n\">Streamlines</span><span class=\"p\">(</span><span class=\"n\">streamline_generator</span><span class=\"p\">)</span>\n<span class=\"n\">sft</span> <span class=\"o\">=</span> <span class=\"n\">StatefulTractogram</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">hardi_img</span><span class=\"p\">,</span> <span class=\"n\">Space</span><span class=\"o\">.</span><span class=\"n\">RASMM</span><span class=\"p\">)</span>\n<span class=\"n\">save_trk</span><span class=\"p\">(</span><span class=\"n\">sft</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tractogram_probabilistic_dg_sh_pfm.trk&quot;</span><span class=\"p\">)</span>\n\n<span class=\"k\">if</span> <span class=\"n\">has_fury</span><span class=\"p\">:</span>\n    <span class=\"n\">scene</span> <span class=\"o\">=</span> <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">Scene</span><span class=\"p\">()</span>\n    <span class=\"n\">scene</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">actor</span><span class=\"o\">.</span><span class=\"n\">line</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">,</span> <span class=\"n\">colormap</span><span class=\"o\">.</span><span class=\"n\">line_colors</span><span class=\"p\">(</span><span class=\"n\">streamlines</span><span class=\"p\">)))</span>\n    <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">record</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">,</span> <span class=\"n\">out_path</span><span class=\"o\">=</span><span class=\"s1\">&#39;tractogram_probabilistic_dg_sh_pfm.png&#39;</span><span class=\"p\">,</span>\n                  <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">800</span><span class=\"p\">,</span> <span class=\"mi\">800</span><span class=\"p\">))</span>\n    <span class=\"k\">if</span> <span class=\"n\">interactive</span><span class=\"p\">:</span>\n        <span class=\"n\">window</span><span class=\"o\">.</span><span class=\"n\">show</span><span class=\"p\">(</span><span class=\"n\">scene</span><span class=\"p\">)</span>\n</pre></div>\n</div>\n<img src=\"../../_images/sphx_glr_tracking_probabilistic_003.png\" srcset=\"../../_images/sphx_glr_tracking_probabilistic_003.png\" alt=\"tracking probabilistic\" class = \"sphx-glr-single-img\"/><figure class=\"align-center\" id=\"id3\">\n<img alt=\"examples_built/13_fiber_tracking/tractogram_probabilistic_dg_sh_pfm.png\" src=\"examples_built/13_fiber_tracking/tractogram_probabilistic_dg_sh_pfm.png\" />\n<figcaption>\n<p><span class=\"caption-text\"><strong>Corpus Callosum using probabilistic direction getter from SH (\npeaks_from_model)</strong></span><a class=\"headerlink\" href=\"#id3\" title=\"Permalink to this image\">\u00b6</a></p>\n</figcaption>\n</figure>\n<p class=\"sphx-glr-timing\"><strong>Total running time of the script:</strong> ( 0 minutes  56.097 seconds)</p>\n<div class=\"sphx-glr-footer sphx-glr-footer-example docutils container\" id=\"sphx-glr-download-examples-built-13-fiber-tracking-tracking-probabilistic-py\">\n<div class=\"sphx-glr-download sphx-glr-download-python docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/7b356ae6482daf4f161e9669f81a3514/tracking_probabilistic.py\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Python</span> <span class=\"pre\">source</span> <span class=\"pre\">code:</span> <span class=\"pre\">tracking_probabilistic.py</span></code></a></p>\n</div>\n<div class=\"sphx-glr-download sphx-glr-download-jupyter docutils container\">\n<p><a class=\"reference download internal\" download=\"\" href=\"../../../_downloads/7baa7bcd96764b1dfcf56865f0a0ca20/tracking_probabilistic.ipynb\"><code class=\"xref download docutils literal notranslate\"><span class=\"pre\">Download</span> <span class=\"pre\">Jupyter</span> <span class=\"pre\">notebook:</span> <span class=\"pre\">tracking_probabilistic.ipynb</span></code></a></p>\n</div>\n</div>\n<p class=\"sphx-glr-signature\"><a class=\"reference external\" href=\"https://sphinx-gallery.github.io\">Gallery generated by Sphinx-Gallery</a></p>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["examples_built/13_fiber_tracking/tracking_pft", "Particle Filtering Tractography", "N", "next"], ["examples_built/13_fiber_tracking/tracking_introduction_eudx_1", "Introduction to Basic Tracking", "P", "previous"]], "sourcename": "examples_built/13_fiber_tracking/tracking_probabilistic.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">An introduction to the Probabilistic Direction Getter</a></li>\n</ul>\n", "display_toc": false, "page_source_suffix": ".rst", "current_page_name": "examples_built/13_fiber_tracking/tracking_probabilistic", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}