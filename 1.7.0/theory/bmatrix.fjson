{"parents": [], "prev": null, "next": null, "title": "The B matrix and Siemens DICOM", "meta": {}, "body": "<section id=\"the-b-matrix-and-siemens-dicom\">\n<h1>The B matrix and Siemens DICOM<a class=\"headerlink\" href=\"#the-b-matrix-and-siemens-dicom\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>This is a short note to explain the nature of the <code class=\"docutils literal notranslate\"><span class=\"pre\">B_matrix</span></code> found in the\nSiemens private (CSA) fields of the DICOM headers of a diffusion-weighted\nacquisition.  We try to explain the relationship between the <code class=\"docutils literal notranslate\"><span class=\"pre\">B_matrix</span></code> and\nthe <em>b value</em> and the <em>gradient vector</em>.  The acquisition is made with a planned\n(requested) b value - say <span class=\"math notranslate nohighlight\">\\(b_{req} = 1000\\)</span>, and with a requested gradient\ndirection <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{req} = [g_x, g_y, g_z]\\)</span> (supposedly a unit vector).</p>\n<p>Note that here we\u2019re using <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}\\)</span> in the sense of an approximation\nto a vector in <span class=\"math notranslate nohighlight\">\\(q\\)</span> space.  Other people use <span class=\"math notranslate nohighlight\">\\(\\mathbf{b}\\)</span> for the same\nconcept, but we\u2019ve chosen <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}\\)</span> to make the exposition clearer.</p>\n<p>For some purposes, we want the q vector <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}_{actual}\\)</span> which is\nequal to <span class=\"math notranslate nohighlight\">\\(b_{actual} . \\mathbf{g}_{actual}\\)</span>. We need to be aware that\n<span class=\"math notranslate nohighlight\">\\(b_{actual}\\)</span> and <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{actual}\\)</span> may be different from the\n<span class=\"math notranslate nohighlight\">\\(b_{req}\\)</span> and <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{req}\\)</span>!  Though the Stejskal and Tanner\nformula is available for the classic PGSE sequence, a different sequence\nmay be used (e.g. TRSE on Siemens Trio), and anyway, the ramps up and\ndown on the gradient field will not be rectangular. The Siemens scanner\nsoftware calculates the effective directional diffusion weighting of the\nacquisition based on the temporal profile of the applied gradient\nvector field. These are in the form of the 6 <code class=\"docutils literal notranslate\"><span class=\"pre\">B_matrix</span></code> values\n<span class=\"math notranslate nohighlight\">\\([b_{xx}, b_{xy}, b_{xz}, b_{yy}, b_{yz}, b_{zz}]\\)</span>.</p>\n<p>In this form they are suitable for use in a least squares estimation of\nthe diffusion tensor via the equations across the set of acquisitions:</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\log(A(\\mathbf{q})/A(0)) = -(b_{xx}D_{xx} + 2b_{xy}D_{xy} + 2b_{xz}D_{xz} + \\\n   b_{yy}D_{yy} + 2b_{yz}D_{yz} + b_{zz}D_{zz})\\]</div>\n<p>The gradient field typically stays in the one gradient direction, in\nthis case the relationship between <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}\\)</span> and the <span class=\"math notranslate nohighlight\">\\(b_{ij}\\)</span> is as\nfollows. If we fill out the symmetric B-matrix as:</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\begin{split}\\mathbf{B} = \\begin{pmatrix}\n              b_{xx} &amp; b_{yx} &amp; b_{yz}\\\\\n              b_{xy} &amp; b_{yy} &amp; b_{xz}\\\\\n              b_{xz} &amp; b_{yz} &amp; b_{zz}\n              \\end{pmatrix}\\end{split}\\]</div>\n<p>then <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span> is equal to the rank 1 tensor\n<span class=\"math notranslate nohighlight\">\\(b\\mathbf{g}\\mathbf{g}^T\\)</span>. One of the ways to recover <span class=\"math notranslate nohighlight\">\\(b\\)</span> and <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}\\)</span>,\nand hence <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}\\)</span>, from\n<span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span> is to do a singular value decomposition of <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}:\n\\mathbf{B} = \\lambda_1\\mathbf{v}_1\\mathbf{v}_1^T +\n\\lambda_2\\mathbf{v}_2\\mathbf{v}_2^T +\n\\lambda_3\\mathbf{v}_3\\mathbf{v}_3^T\\)</span>, where only one of the <span class=\"math notranslate nohighlight\">\\(\\lambda_i\\)</span>,\nsay <span class=\"math notranslate nohighlight\">\\(\\lambda_1\\)</span>, is effectively non-zero. Then <span class=\"math notranslate nohighlight\">\\(b = \\lambda_1\\)</span>, <span class=\"math notranslate nohighlight\">\\(\\mathbf{g} =\n\\pm\\mathbf{v}_1,\\)</span> and <span class=\"math notranslate nohighlight\">\\(\\mathbf{q} =\n\\pm\\lambda_1\\mathbf{v}_1.\\)</span> The choice of sign is arbitrary\n(essentially we have a choice between two possible square roots of the\nrank 1 tensor <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span>). Once we have <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}_{actual}\\)</span> we can\ncalculate <span class=\"math notranslate nohighlight\">\\(b_{actual} = |\\mathbf{q}_{actual}|\\)</span> and <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{actual}\n= \\mathbf{q}_{actual} / b_{actual}\\)</span>. Various software packages\n(e.g. FSL\u2019s DFT-DTIFIT) expect to get 3 \u00d7 N and 1 \u00d7 N arrays of\n<span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{actual}\\)</span> and <span class=\"math notranslate nohighlight\">\\(b_{actual}\\)</span> values as their inputs.</p>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "theory/bmatrix.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">The B matrix and Siemens DICOM</a></li>\n</ul>\n", "display_toc": false, "page_source_suffix": ".rst", "current_page_name": "theory/bmatrix", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}