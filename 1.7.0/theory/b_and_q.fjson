{"parents": [], "prev": null, "next": null, "title": "DIY Stuff about b and q", "meta": {}, "body": "<section id=\"diy-stuff-about-b-and-q\">\n<span id=\"b-and-q\"></span><h1>DIY Stuff about b and q<a class=\"headerlink\" href=\"#diy-stuff-about-b-and-q\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>This is a short note to explain the nature of the <code class=\"docutils literal notranslate\"><span class=\"pre\">B_matrix</span></code> found in the\nSiemens private (CSA) fields of the DICOM headers of a diffusion weighted\nacquisition.  We trying to explain the relationship between the <code class=\"docutils literal notranslate\"><span class=\"pre\">B_matrix</span></code> and\nthe <em>b value</em> and the <em>gradient vector</em>.  The acquisition is made with a planned\n(requested) <span class=\"math notranslate nohighlight\">\\(b\\)</span>-value - say <span class=\"math notranslate nohighlight\">\\(b_{req} = 1000\\)</span>, and with a requested gradient\ndirection <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{req} = [g_x, g_y, g_z]\\)</span> (supposedly a unit vector) and\npeak amplitude <span class=\"math notranslate nohighlight\">\\(G\\)</span>. When the sequence runs the gradient is modulated by an\namplitude envelope <span class=\"math notranslate nohighlight\">\\(\\rho(t)\\)</span> with <span class=\"math notranslate nohighlight\">\\(\\max |\\rho(t)| = 1\\)</span> so that the time course\nof the gradient is <span class=\"math notranslate nohighlight\">\\(G\\rho(t)\\mathbf{g}.\\)</span> <span class=\"math notranslate nohighlight\">\\(G\\)</span> is measured in units of <span class=\"math notranslate nohighlight\">\\(T\n\\mathrm{mm}^-1.\\)</span> This leads to an important temporal weighting parameter of the\nacquisition:</p>\n<div class=\"math notranslate nohighlight\">\n\\[R = \\int_0^T ( \\int_0^t \\rho ( \\tau ) \\, d{ \\tau } )^2 \\, d{t}.\\]</div>\n<p>(See Basser, Matiello and LeBihan, 1994.) Another formulation involves\nthe introduction of k-space. In standard in-plane MR image encoding</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\mathbf{k} = \\gamma \\int \\mathbf{g}(t)dt.\\]</div>\n<p>For the classical Stejskal and Tanner pulsed gradient spin echo (PGSE)\nparadigm where two rectangular pulses of width <span class=\"math notranslate nohighlight\">\\(\\delta\\)</span> seconds are\nspaced with their onsets <span class=\"math notranslate nohighlight\">\\(\\Delta\\)</span> seconds apart <span class=\"math notranslate nohighlight\">\\(R = \\Delta\n(\\Delta-\\delta/3)^2.\\)</span> The units of <span class=\"math notranslate nohighlight\">\\(R\\)</span> are <span class=\"math notranslate nohighlight\">\\(s^3\\)</span>. The <span class=\"math notranslate nohighlight\">\\(b\\)</span>-matrix has\nentries</p>\n<div class=\"math notranslate nohighlight\">\n\\[b_{ij} = \\gamma^2 G^2 g_i g_j R,\\]</div>\n<p>where <span class=\"math notranslate nohighlight\">\\(\\gamma\\)</span> is the gyromagnetic radius (units\n<span class=\"math notranslate nohighlight\">\\(\\mathrm{radians}.\\mathrm{seconds}^{-1}.T^{-1}\\)</span>) and <span class=\"math notranslate nohighlight\">\\(i\\)</span> and <span class=\"math notranslate nohighlight\">\\(j\\)</span> are\naxis direcrtions from <span class=\"math notranslate nohighlight\">\\(x,y,z\\)</span> . The units of the B-matrix are\n<span class=\"math notranslate nohighlight\">\\(\\mathrm{radians}^2 . \\mathrm{seconds} .  \\mathrm{mm}^{-2}.\\)</span></p>\n<div class=\"math notranslate nohighlight\">\n\\[\\mathbf{B} = \\gamma^2 G^2 R \\mathbf{g} \\mathbf{g}^T.\\]</div>\n<p>The b-value for the acquisition is the trace of <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span> and is\ngiven by</p>\n<div class=\"math notranslate nohighlight\">\n\\[b = \\gamma^2 G^2 R \\|\\mathbf{g}\\|^2 = \\gamma^2 G^2 R.\\]</div>\n</section>\n<section id=\"the-b-matrix-and-siemens-dicom\">\n<h1>The B matrix and Siemens DICOM<a class=\"headerlink\" href=\"#the-b-matrix-and-siemens-dicom\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>Though the Stejskal and Tanner formula is available for the classic\nPGSE sequence, a different sequence may be used (e.g. TRSE on Siemens\nTrio), and anyway the ramps up and down on the gradient field will not\nbe rectangular. The Siemens scanner software calculates the actual\nvalues of the <span class=\"math notranslate nohighlight\">\\(b_{ij}\\)</span> by numerical integration of the formula above\nfor <span class=\"math notranslate nohighlight\">\\(R\\)</span>. These values are in the form of the 6 \u2018B-matrix\u2019 values\n<span class=\"math notranslate nohighlight\">\\([b_{xx}, b_{xy}, b_{xz}, b_{yy}, b_{yz}, b_{zz}]\\)</span>.</p>\n<p>In this form they are suitable for use in a least squares estimation of\nthe diffusion tensor via the equations across the set of acquisitions:</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\log(A(\\mathbf{q})/A(0)) = -(b_{xx}D_{xx} + 2b_{xy}D_{xy} + 2b_{xz}D_{xz} + \\\n   b_{yy}D_{yy} + 2b_{yz}D_{yz} + b_{zz}D_{zz})\\]</div>\n<p>The gradient field typically stays in the one gradient direction, in\nthis case the relationship between <span class=\"math notranslate nohighlight\">\\(b\\)</span>, <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}\\)</span> and the <span class=\"math notranslate nohighlight\">\\(b_{ij}\\)</span> is as\nfollows. If we fill out the symmetric B-matrix as:</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\begin{split}\\mathbf{B} = \\begin{pmatrix}\n              b_{xx} &amp; b_{yx} &amp; b_{yz}\\\\\n              b_{xy} &amp; b_{yy} &amp; b_{xz}\\\\\n              b_{xz} &amp; b_{yz} &amp; b_{zz}\n              \\end{pmatrix}\\end{split}\\]</div>\n<p>then <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span> is equal to the rank 2 tensor <span class=\"math notranslate nohighlight\">\\(\\gamma^2 G^2 R\n\\mathbf{g} \\mathbf{g}^T\\)</span>. By performing an eigenvalue and\neigenvector decomposition of <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span> we obtain</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\mathbf{B} = \\lambda_1\\mathbf{v}_1\\mathbf{v}_1^T +\n             \\lambda_2\\mathbf{v}_2\\mathbf{v}_2^T +\n             \\lambda_3\\mathbf{v}_3\\mathbf{v}_3^T,\\]</div>\n<p>where only one of the <span class=\"math notranslate nohighlight\">\\(\\lambda_i\\)</span>, say <span class=\"math notranslate nohighlight\">\\(\\lambda_1\\)</span>, is (effectively)\nnon-zero. (Because the gradient is always a multiple of a constant\ndirection <span class=\"math notranslate nohighlight\">\\(\\mathbf{B}\\)</span> is a effectively a rank 1 tensor.) Then\n<span class=\"math notranslate nohighlight\">\\(\\mathbf{g} = \\pm\\mathbf{v}_1\\)</span>, and <span class=\"math notranslate nohighlight\">\\(b = \\gamma^2 G^2 R =\n\\lambda_1\\)</span>. The <code class=\"docutils literal notranslate\"><span class=\"pre\">b-vector</span></code> <span class=\"math notranslate nohighlight\">\\(\\mathbf{b}\\)</span> is given by:</p>\n<div class=\"math notranslate nohighlight\">\n\\[\\mathbf{b}_{\\mathrm{actual}} = \\gamma^2 G^2 R \\mathbf{g}_{\\mathrm{actual}}\n = \\lambda_1 \\mathbf{v}_1.\\]</div>\n<p>Once we have <span class=\"math notranslate nohighlight\">\\(\\mathbf{b}_{actual}\\)</span> we can calculate <span class=\"math notranslate nohighlight\">\\(b_{actual} =\n\\|\\mathbf{b}_{actual}\\|\\)</span> and <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{actual} = \\mathbf{b}_{actual}\n/ b_{actual}\\)</span>. Various software packages (e.g. FSL\u2019s DFT-DTIFIT) expect\nto get N x 3 and N x 1 arrays of <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}_{actual}\\)</span> (<code class=\"docutils literal notranslate\"><span class=\"pre\">bvecs</span></code>) and\n<span class=\"math notranslate nohighlight\">\\(b_{actual}\\)</span> values (<code class=\"docutils literal notranslate\"><span class=\"pre\">bvals</span></code>) as their inputs.</p>\n</section>\n<section id=\"and-what-about-q\">\n<h1>\u2026 and what about \u2018q\u2019?<a class=\"headerlink\" href=\"#and-what-about-q\" title=\"Permalink to this heading\">\u00b6</a></h1>\n<p>Callaghan, Eccles and Xia (1988) showed that the signal from the\nnarrow pulse PGSE paradigm measured the Fourier transform of the\ndiffusion displacement propagator. Propagation space is measured in\ndisplacement per unit time <span class=\"math notranslate nohighlight\">\\((\\mathrm{mm}.\\mathrm{seconds}^{-1})\\)</span>. They\nnamed the reciprocal space <code class=\"docutils literal notranslate\"><span class=\"pre\">q-space</span></code> with units of\n<span class=\"math notranslate nohighlight\">\\(\\mathrm{seconds}.\\mathrm{mm}^{-1}\\)</span>.</p>\n<div class=\"math notranslate nohighlight\" id=\"equation-fourier\">\n<span class=\"eqno\">(1)<a class=\"headerlink\" href=\"#equation-fourier\" title=\"Permalink to this equation\">\u00b6</a></span>\\[q = \\gamma \\delta G /{2\\pi}\\]</div>\n<div class=\"math notranslate nohighlight\">\n\\[b = 4 \\pi^2 q^2 \\Delta\\]</div>\n<p>Diffusion spectroscopy measures signal over a wide range of <span class=\"math notranslate nohighlight\">\\(b\\)</span>-values\n(or <span class=\"math notranslate nohighlight\">\\(q\\)</span>-values) and diffusion times (<span class=\"math notranslate nohighlight\">\\(\\Delta\\)</span>) and performs a <span class=\"math notranslate nohighlight\">\\(q\\)</span>-space\nanalysis (Fourier transform of the diffusion signal decay).</p>\n<p>There remains a bit of mystery as to how <span class=\"math notranslate nohighlight\">\\(\\mathbf{q}\\)</span> (as a vector in\n<span class=\"math notranslate nohighlight\">\\(q\\)</span>-space) is specified for other paradigms. We think that (a) it only\nmatters up to a scale factor, and (b) we can loosely identify\n<span class=\"math notranslate nohighlight\">\\(\\mathbf{q}\\)</span> with <span class=\"math notranslate nohighlight\">\\(b\\mathbf{g}\\)</span>, where <span class=\"math notranslate nohighlight\">\\(\\mathbf{g}\\)</span> is the unit\nvector in the gradient direction.</p>\n</section>\n", "metatags": "<meta name=\"generator\" content=\"Docutils 0.19: https://docutils.sourceforge.io/\" />\n", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"]], "sourcename": "theory/b_and_q.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">DIY Stuff about b and q</a></li>\n<li><a class=\"reference internal\" href=\"#the-b-matrix-and-siemens-dicom\">The B matrix and Siemens DICOM</a></li>\n<li><a class=\"reference internal\" href=\"#and-what-about-q\">\u2026 and what about \u2018q\u2019?</a></li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "theory/b_and_q", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}